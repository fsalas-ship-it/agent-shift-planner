<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Shift Admin — Capacidad + Borrado</title>
  <style>
    :root{
      --bg:#05060a; --edge:#161b21; --text:#e5e7eb; --mut:#9ca3af; --accent:#00e676; --accent-2:#00c853;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background:var(--bg)}
    .wrap{max-width:1400px; margin:0 auto; padding:24px}
    header{display:flex; gap:16px; justify-content:space-between; align-items:end; margin-bottom:12px}
    h1{margin:0; font-size:22px; font-weight:900}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00)); border:1px solid var(--edge); border-radius:16px; padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .lbl{font-size:12px; color:#9ca3af; margin-bottom:6px}
    .inp, input[type="date"], input[type="number"]{background:#0b0f13; color:var(--text); border:1px solid #1c232a; border-radius:12px; padding:10px 12px}
    .btn{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#062e15; font-weight:900; border:none; border-radius:12px; padding:10px 14px; cursor:pointer}
    .btn.ghost{background:transparent; color:#a7f3d0; border:1px solid rgba(0,230,118,0.35)}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{padding:10px 12px; font-size:14px; text-align:left}
    th{color:#a7f3d0; font-weight:800}
    tr{background:#0b0f13; border:1px solid #1c232a}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tr td:last-child, tr th:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}
    .mut{color:#9ca3af; font-size:12px}
    .status{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px}
    .ok{background:rgba(22,163,74,0.12); color:#86efac; border:1px solid rgba(22,163,74,0.35)}
    .warn{background:rgba(245,158,11,0.12); color:#fde68a; border:1px solid rgba(245,158,11,0.35)}
    .bad{background:rgba(239,68,68,0.12); color:#fecaca; border:1px solid rgba(239,68,68,0.35)}
    .chart{height:520px; display:flex; align-items:flex-end; gap:12px; padding:12px; background:#0b0f13; border:1px solid #1c232a; border-radius:14px}
    .bar{width:28px; border-radius:6px; background:linear-gradient(180deg, rgba(0,230,118,0.35), rgba(0,200,83,0.25)); border:1px solid rgba(0,230,118,0.35)}
    .bar.ghost{background:linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.04)); border-color:#2a3238}
    .xlabels{display:flex; justify-content:space-between; gap:8px; font-size:12px; color:#94a3b8; margin-top:6px}
    .danger{background:linear-gradient(180deg, #ef4444, #dc2626); color:white; border:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Agent Shift Admin — Capacidad + Borrado</h1>
        <div class="mut">Programados vs requeridos · CSV · Modelo de retorno · Eliminación de turnos</div>
      </div>
      <div class="row">
        <div>
          <div class="lbl">Fecha</div>
          <input class="inp" type="date" id="date">
        </div>
        <div style="align-self:end"><button class="btn" id="refresh">Actualizar</button></div>
        <div style="align-self:end"><button class="btn ghost" id="csv">Descargar CSV</button></div>
      </div>
    </header>

    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <div>
          <div class="lbl">% total de retorno</div>
          <input class="inp" type="range" min="5" max="50" value="30" id="pct">
          <div class="mut"><span id="pctv">30</span>%</div>
        </div>
        <div>
          <div class="lbl">Horas para retorno</div>
          <input class="inp" type="range" min="1" max="8" value="3" id="span">
          <div class="mut"><span id="spanv">3</span> h</div>
        </div>
        <div>
          <div class="lbl">Pesos (se normalizan)</div>
          <div id="weights" class="row"></div>
        </div>
        <div>
          <div class="lbl">Capacidad por asesor</div>
          <input class="inp" type="number" id="cap" value="30" min="1">
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="lbl">Tabla por hora</div>
      <table>
        <thead>
          <tr>
            <th>Hora</th>
            <th>Asesores programados</th>
            <th>Capacidad (msgs/h)</th>
            <th>Envíos (mkt)</th>
            <th>Mensajes esperados</th>
            <th>Asesores requeridos</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="row" style="justify-content:space-between; align-items:end">
        <div>
          <div class="lbl">Gestión de turnos del día (borrar específicos)</div>
          <table>
            <thead>
              <tr>
                <th>Hora</th><th>Nombre</th><th>Email</th><th>Canal</th><th>Acción</th>
              </tr>
            </thead>
            <tbody id="manage"></tbody>
          </table>
        </div>
        <div>
          <div class="lbl">Borrar TODOS por email (día)</div>
          <div class="row">
            <input class="inp" placeholder="email@dominio" id="bulkEmail" style="min-width:240px">
            <button class="btn danger" id="bulkBtn">Borrar del día</button>
          </div>
          <div class="mut" style="margin-top:6px">Afecta solo la fecha seleccionada.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="lbl">Gráfica (mensajes esperados y asesores requeridos)</div>
      <div id="chart" class="chart"></div>
      <div id="xlabels" class="xlabels"></div>
    </div>

    <div id="msg" class="mut" style="margin-top:8px"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://wbplsmimcuphytdfjapz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false }});
    const HOURS = [9,10,11,12,13,14,15,16,17,18,19,20,21];

    function $(id){return document.getElementById(id);}
    const state = { pct:30, span:3, weights:[], cap:30, scheduled:new Map(), sends:new Map(), rows:[] };

    init();
    function init(){
      const d = new Date();
      const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      $('date').value = iso;
      $('pct').oninput = ()=>{ state.pct = parseInt($('pct').value,10); $('pctv').textContent = state.pct; recompute(); };
      $('span').oninput = ()=>{ state.span = parseInt($('span').value,10); $('spanv').textContent = state.span; renderWeights(); recompute(); };
      $('cap').oninput = ()=>{ state.cap = Math.max(1, parseInt($('cap').value||'30',10)); recompute(); };
      $('refresh').onclick = load;
      $('csv').onclick = exportCSV;
      $('bulkBtn').onclick = bulkDelete;
      renderWeights();
      renderRows();
      load();
    }

    function renderWeights(){
      const box = $('weights'); box.innerHTML='';
      state.weights = [];
      for(let i=1;i<=state.span;i++){
        const input = document.createElement('input');
        input.type='number'; input.min='0'; input.value = (i===1? 50 : Math.round((50/(state.span-1))||0));
        input.className='inp'; input.style.width='80px';
        input.oninput = ()=>{recompute();};
        box.appendChild(input);
        state.weights.push(input);
      }
    }

    async function load(){
      $('msg').textContent = 'Cargando…';
      const date = $('date').value;
      const res = await sb.from('bookings').select('date,hour,name,email,channel,cap_msg,inserted_at').eq('date', date).order('hour', {ascending:true});
      if(res.error){ $('msg').textContent = 'Error: ' + res.error.message; return; }
      state.rows = res.data;
      state.scheduled = new Map(); HOURS.forEach(h=> state.scheduled.set(h, 0));
      res.data.forEach(r=>{ if(state.scheduled.has(r.hour)){ state.scheduled.set(r.hour, state.scheduled.get(r.hour)+1); } });
      $('msg').textContent = 'Total filas: ' + res.data.length;
      renderRows();
      renderManage();
      recompute();
    }

    function renderManage(){
      const tb = $('manage'); tb.innerHTML='';
      state.rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.hour}:00</td><td>${r.name}</td><td>${r.email}</td><td>${r.channel}</td>`;
        const tdAct = document.createElement('td');
        const b = document.createElement('button'); b.className='btn danger'; b.textContent='Borrar';
        b.onclick = ()=> deleteOne(r.date, r.hour, r.email);
        tdAct.appendChild(b); tr.appendChild(tdAct);
        tb.appendChild(tr);
      });
    }

    async function deleteOne(date, hour, email){
      if(!confirm(`Borrar turno de ${email} a las ${hour}:00 del ${date}?`)) return;
      const { error } = await sb.from('bookings').delete().match({ date, hour, email });
      if(error){ alert('Error borrando: ' + error.message); return; }
      load();
    }

    async function bulkDelete(){
      const email = $('bulkEmail').value.trim();
      const date = $('date').value;
      if(!email){ alert('Escribe un email'); return; }
      if(!confirm(`Borrar TODOS los turnos de ${email} en ${date}?`)) return;
      const { error } = await sb.from('bookings').delete().match({ date, email });
      if(error){ alert('Error borrando: ' + error.message); return; }
      $('bulkEmail').value='';
      load();
    }

    function renderRows(){
      const tb = $('rows'); tb.innerHTML='';
      HOURS.forEach(h=>{
        const tr = document.createElement('tr');
        const tdHour = document.createElement('td'); tdHour.textContent = `${h}:00`; tr.appendChild(tdHour);
        const tdAgents = document.createElement('td'); tdAgents.id = `agents-${h}`; tdAgents.textContent = state.scheduled.get(h) || 0; tr.appendChild(tdAgents);
        const tdCap = document.createElement('td'); tdCap.id = `cap-${h}`; tdCap.textContent = (state.scheduled.get(h)||0) * state.cap; tr.appendChild(tdCap);
        const tdSend = document.createElement('td');
        const inp = document.createElement('input'); inp.type='number'; inp.min='0'; inp.value='0'; inp.className='inp'; inp.style.width='120px';
        inp.oninput = ()=>{ state.sends.set(h, Math.max(0, parseInt(inp.value||'0',10))); recompute(); };
        tdSend.appendChild(inp); tr.appendChild(tdSend);
        const tdExp = document.createElement('td'); tdExp.id = `exp-${h}`; tdExp.textContent = '0'; tr.appendChild(tdExp);
        const tdReq = document.createElement('td'); tdReq.id = `req-${h}`; tdReq.textContent = '0'; tr.appendChild(tdReq);
        const tdStatus = document.createElement('td'); tdStatus.id = `status-${h}`; tdStatus.textContent = '—'; tr.appendChild(tdStatus);
        tb.appendChild(tr);
      });
      drawChart([],[]);
    }

    function recompute(){
      const wvals = state.weights.map(w => Math.max(0, parseFloat(w.value||'0')));
      let sum = wvals.reduce((a,b)=>a+b,0); if(sum<=0) sum=1;
      const norm = wvals.map(w=>w/sum);
      const sends = HOURS.map(h => state.sends.get(h)||0);
      const resp = HOURS.map(()=>0);
      for(let i=0;i<HOURS.length;i++){
        const val = sends[i] * (state.pct/100);
        for(let k=0;k<state.span;k++){
          const dest = i + (k+1);
          if(dest < resp.length){ resp[dest] += val * norm[k]; }
        }
      }
      const req = resp.map(v => Math.ceil(v / Math.max(1, state.cap)));
      HOURS.forEach((h,idx)=>{
        const scheduled = state.scheduled.get(h)||0;
        const capacityMsgs = scheduled * state.cap;
        $('agents-'+h).textContent = scheduled;
        $('cap-'+h).textContent = capacityMsgs;
        $('exp-'+h).textContent = Math.round(resp[idx]);
        $('req-'+h).textContent = req[idx];
        const statusEl = $('status-'+h);
        const ratio = req[idx] <= 0 ? 1 : (scheduled / req[idx]);
        if(ratio >= 1){ statusEl.textContent='Ok'; statusEl.className='status ok'; }
        else if(ratio >= 0.8){ statusEl.textContent='Atención'; statusEl.className='status warn'; }
        else { statusEl.textContent='Crítico'; statusEl.className='status bad'; }
      });
      drawChart(resp, req);
    }

    function drawChart(resp, req){
      const chart = document.getElementById('chart'); chart.innerHTML='';
      const max = Math.max(1, ...resp, ...req);
      for(let i=0;i<HOURS.length;i++){
        const wrap = document.createElement('div');
        wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center'; wrap.style.gap='6px';
        const barWrap = document.createElement('div');
        barWrap.style.display='flex'; barWrap.style.alignItems='flex-end'; barWrap.style.gap='6px'; barWrap.style.height='100%';
        const b1 = document.createElement('div'); b1.className='bar'; b1.style.height = (resp[i]/max*100)+'%';
        const b2 = document.createElement('div'); b2.className='bar ghost'; b2.style.height = (req[i]/max*100)+'%';
        barWrap.appendChild(b1); barWrap.appendChild(b2);
        wrap.appendChild(barWrap);
        chart.appendChild(wrap);
      }
      const xl = document.getElementById('xlabels'); xl.innerHTML=''; HOURS.forEach(h=>{ const s=document.createElement('div'); s.textContent=h; xl.appendChild(s); });
    }

    async function exportCSV(){
      const date = $('date').value;
      const res = await sb.from('bookings').select('date,hour,name,email,channel,cap_msg,inserted_at').eq('date', date).order('hour',{ascending:true});
      if(res.error){ alert('Error CSV: ' + res.error.message); return; }
      const rows = [['date','hour','name','email','channel','cap_msg','inserted_at']];
      res.data.forEach(r=> rows.push([r.date, r.hour, r.name, r.email, r.channel, r.cap_msg, r.inserted_at]));
      const csv = rows.map(r=> r.map(x=>'"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='bookings_'+date+'.csv'; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
