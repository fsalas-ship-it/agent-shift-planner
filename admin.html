<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin â€” Navidad de Ventas (Turnos & Cierre Comercial)</title>
<style>
:root{
  --bg:#020617;
  --panel:#020617;
  --edge:#1f2937;
  --text:#e5e7eb;
  --mut:#9ca3af;
  --acc:#22c55e;
  --acc2:#16a34a;
  --bad:#ef4444;
  --mid:#f59e0b;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at 0 0,rgba(248,113,113,.15),transparent 60%),
    radial-gradient(circle at 100% 0,rgba(34,197,94,.18),transparent 60%),
    radial-gradient(circle at 50% 100%,rgba(56,189,248,.16),transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.wrap{
  max-width:1120px;
  margin:0 auto;
  padding:24px 16px 40px;
  position:relative;
}

/* Luces navideÃ±as */
.lights{
  position:absolute;
  inset:0 0 auto 0;
  height:48px;
  pointer-events:none;
  display:flex;
  justify-content:center;
  gap:18px;
}
.light{
  width:8px;
  height:16px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 0,#fff,rgba(248,250,252,.1));
  box-shadow:0 0 14px rgba(248,250,252,.6);
  animation:twinkle 1.6s ease-in-out infinite;
}
.light:nth-child(3n){background:#f97373;box-shadow:0 0 12px rgba(248,113,113,.9);}
.light:nth-child(3n+1){background:#4ade80;box-shadow:0 0 12px rgba(74,222,128,.9);}
.light:nth-child(3n+2){background:#facc15;box-shadow:0 0 12px rgba(250,204,21,.9);}
.light:nth-child(4n){animation-delay:.3s}
.light:nth-child(5n){animation-delay:.6s}
@keyframes twinkle{
  0%,100%{opacity:.5;transform:translateY(0)}
  50%{opacity:1;transform:translateY(2px)}
}

header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  margin-top:32px;
  margin-bottom:16px;
}
h1{
  margin:0;
  font-size:24px;
  font-weight:900;
  letter-spacing:.16em;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:10px;
}
h1 span.emoji{font-size:24px}
.sub{font-size:12px;color:var(--mut)}

.hero-copy{
  margin-top:6px;
  font-size:13px;
  color:#e5e7eb;
}

/* Banner */
.banner{
  margin:10px 0 18px;
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(248,250,252,.08);
  background:linear-gradient(145deg,rgba(34,197,94,.22),rgba(15,23,42,.98));
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.banner-pill{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.16em;
  padding:6px 10px;
  border-radius:999px;
  background:radial-gradient(circle at 0 0,#f97373,#fb923c);
  color:#111827;
}
.banner-text{font-size:13px;color:#f9fafb}

/* Cards */
.card{
  background:radial-gradient(circle at 0 0,rgba(148,163,184,.16),transparent 55%),
             rgba(15,23,42,.96);
  border:1px solid var(--edge);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
.card h2{
  margin:0 0 8px 0;
  font-size:16px;
}

/* Inputs / layout */
.grid3{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:10px;
}
.grid2{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px;
}
.lbl{
  font-size:12px;
  color:var(--mut);
  margin-bottom:4px;
}
.inp{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #1f2937;
  background:#020617;
  color:var(--text);
  font-size:13px;
}
.btn{
  padding:8px 12px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-size:13px;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn.pri{
  background:linear-gradient(145deg,#22c55e,#16a34a);
  color:#052e16;
}
.btn.sec{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #1f2937;
}
.msg{
  font-size:12px;
  margin-top:6px;
}
.msg.err{color:var(--bad)}
.msg.ok{color:#22c55e}
.msg.mut{color:var(--mut)}

/* Roster */
.roster{
  margin-top:8px;
  border-top:1px solid #1f2937;
}
.hr{
  padding:10px 0;
  border-bottom:1px dashed #1f2937;
}
.hr-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:4px;
}
.hr-head h3{
  margin:0;
  font-size:14px;
}
.hr-head span{
  font-size:12px;
  color:var(--mut);
}
.pills{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #24303a;
  background:#020617;
  font-size:12px;
}
.pill-name{color:#e5e7eb}
.pill-chan{color:#e5e7eb}
.pill-meta{color:#9ca3af}

/* Performance */
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:8px;
  font-size:13px;
}
th,td{
  border:1px solid #1f2937;
  padding:6px 8px;
}
th{
  background:#020617;
  text-align:left;
}
input.perf{
  width:100%;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #1f2937;
  border-radius:8px;
  padding:4px 6px;
  font-size:13px;
}
.badge{
  display:inline-block;
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid transparent;
}
.badge.ok{
  border-color:#22c55e;
  background:rgba(34,197,94,.12);
  color:#bbf7d0;
}
.badge.mid{
  border-color:#f59e0b;
  background:rgba(245,158,11,.12);
  color:#fde68a;
}
.badge.low{
  border-color:#ef4444;
  background:rgba(239,68,68,.12);
  color:#fecaca;
}

/* Totales y resumen */
.totals{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  margin-top:10px;
  font-size:13px;
}
.totals div span.label{
  color:var(--mut);
}
.totals div span.value{
  font-weight:700;
}
textarea{
  width:100%;
  min-height:120px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #1f2937;
  background:#020617;
  color:#e5e7eb;
  padding:8px 10px;
  font-size:12px;
  resize:vertical;
}

@media(max-width:900px){
  header{flex-direction:column;align-items:flex-start}
  .grid3{grid-template-columns:minmax(0,1fr)}
  .grid2{grid-template-columns:minmax(0,1fr)}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="lights">
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
  </div>

  <header>
    <div>
      <h1><span class="emoji">ðŸŽ„</span> ADMIN VENTAS</h1>
      <div class="hero-copy">
        Control navideÃ±o de operaciÃ³n: turnos por hora + cierre comercial por asesor.
      </div>
      <div class="sub">
        Horario de turnos: <b>9:00 a. m.</b> a <b>9:00 p. m.</b> (domingo a domingo).
      </div>
    </div>
  </header>

  <div class="banner">
    <div class="banner-pill">Holiday Control Center</div>
    <div class="banner-text">
      Ve quiÃ©n estÃ¡ conectado por hora y arma tu cierre diario con ventas, llamadas, mensajes y cash en segundos. ðŸ’¸
    </div>
  </div>

  <!-- SecciÃ³n 1: Turnos por hora -->
  <section class="card">
    <h2>Turnos del dÃ­a (roster)</h2>
    <div class="grid3">
      <div>
        <div class="lbl">Fecha</div>
        <input class="inp" type="date" id="dateRoster">
      </div>
      <div style="align-self:end">
        <button class="btn pri" id="loadRosterBtn">Cargar turnos</button>
      </div>
      <div style="align-self:end">
        <span class="msg mut" id="rosterMsg">Selecciona una fecha para ver las horas con asesores programados.</span>
      </div>
    </div>

    <div id="roster" class="roster"></div>
  </section>

  <!-- SecciÃ³n 2: Panel comercial manual -->
  <section class="card">
    <h2>Cierre comercial del dÃ­a</h2>
    <div class="grid3">
      <div>
        <div class="lbl">Fecha del cierre</div>
        <input class="inp" type="date" id="datePerf">
      </div>
      <div>
        <div class="lbl">Moneda (para el texto)</div>
        <input class="inp" type="text" id="currency" value="$">
      </div>
      <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn pri" id="addPerfRow">Agregar asesor</button>
        <button class="btn sec" id="clearPerf">Limpiar</button>
      </div>
    </div>
    <div class="msg mut" style="margin-top:6px">
      Ingresa manualmente los datos por asesor: ventas, cash, llamadas y mensajes atendidos. El panel calcula totales y conversiones.
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Asesor</th>
          <th>Email</th>
          <th>Ventas</th>
          <th>Cash</th>
          <th>Llamadas</th>
          <th>Mensajes</th>
          <th>Conv.</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="perfBody"></tbody>
    </table>

    <div class="totals">
      <div><span class="label">Ventas totales: </span><span class="value" id="totSales">0</span></div>
      <div><span class="label">Cash total: </span><span class="value" id="totCash">0</span></div>
      <div><span class="label">Llamadas totales: </span><span class="value" id="totCalls">0</span></div>
      <div><span class="label">Mensajes totales: </span><span class="value" id="totMsgs">0</span></div>
      <div><span class="label">ConversiÃ³n global: </span><span class="value" id="totConv">0%</span></div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn pri" id="genSummary">Generar texto de cierre</button>
      <span class="msg mut">Copia y pega este resumen en tu canal de cierre diario.</span>
    </div>
    <textarea id="summaryText" readonly placeholder="AquÃ­ aparecerÃ¡ el texto de cierre diarioâ€¦"></textarea>
  </section>
</div>

<script>
// === Supabase config (igual que el panel de agentes) ===
const SUPABASE_URL = "https://wbplsmimcuphytdfjapz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false }});

// Horario 9:00â€“21:00
const HOURS = [9,10,11,12,13,14,15,16,17,18,19,20,21];

const $ = id => document.getElementById(id);

// Fecha por defecto = hoy
(function initDates(){
  const d = new Date();
  const iso = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('dateRoster').value = iso;
  $('datePerf').value = iso;
})();

/* =========================
   1) ROSTER POR HORA
   ========================= */

$('loadRosterBtn').onclick = loadRoster;

async function loadRoster(){
  const day = ($('dateRoster').value || '').trim();
  const msg = $('rosterMsg');
  const box = $('roster');
  if(!day){
    msg.className = 'msg err';
    msg.textContent = 'Selecciona una fecha.';
    return;
  }
  msg.className = 'msg mut';
  msg.textContent = 'Cargando turnosâ€¦';
  box.innerHTML = '';

  try{
    const { data, error } = await sb
      .from('bookings')
      .select('date,hour,name,email,channel,cap_msg')
      .eq('date', day)
      .order('hour',{ascending:true});

    if(error){
      msg.className = 'msg err';
      msg.textContent = 'Error al cargar: ' + error.message;
      return;
    }

    const byHour = {};
    HOURS.forEach(h => byHour[h] = []);
    (data || []).forEach(row => {
      const h = Number(row.hour);
      if(!byHour.hasOwnProperty(h)) return;
      byHour[h].push(row);
    });

    let anyHour = false;
    HOURS.forEach(h => {
      const people = byHour[h] || [];
      if(!people.length) return; // solo horas con gente
      anyHour = true;

      const hr = document.createElement('div');
      hr.className = 'hr';

      const head = document.createElement('div');
      head.className = 'hr-head';
      head.innerHTML = `
        <h3>${labelHour(h)}</h3>
        <span>${people.length} asesor(es)</span>
      `;
      hr.appendChild(head);

      const pills = document.createElement('div');
      pills.className = 'pills';

      // mapas Ãºnicos por email
      const seen = new Set();
      people.forEach(p => {
        const email = (p.email || '').toLowerCase();
        const key = email || (p.name||'');
        if(seen.has(key)) return;
        seen.add(key);

        const pill = document.createElement('div');
        pill.className = 'pill';
        const chan = (p.channel || 'mensajes');
        const icon = channelIcon(chan);

        pill.innerHTML = `
          <span class="pill-name">${p.name || 'â€”'}</span>
          <span class="pill-chan">${icon}</span>
          <span class="pill-meta">${email}</span>
        `;
        pills.appendChild(pill);
      });

      hr.appendChild(pills);
      box.appendChild(hr);
    });

    if(!anyHour){
      box.innerHTML = '<div class="msg mut" style="margin-top:8px">No hay turnos programados para esta fecha.</div>';
      msg.className = 'msg ok';
      msg.textContent = 'Sin turnos para ' + day + '.';
    }else{
      msg.className = 'msg ok';
      msg.textContent = 'Turnos cargados para ' + day + '.';
    }

  }catch(e){
    msg.className = 'msg err';
    msg.textContent = 'ExcepciÃ³n: ' + (e?.message || String(e));
  }
}

function labelHour(h){
  return String(h).padStart(2,'0') + ':00';
}
function channelIcon(channel){
  if(channel === 'llamadas') return 'ðŸ“ž';
  if(channel === 'mensajes') return 'ðŸ’¬';
  return 'ðŸ’¬ðŸ“ž';
}

/* =========================
   2) PANEL COMERCIAL MANUAL
   ========================= */

let perfRows = []; // {name,email,sales,cash,calls,msgs}

$('addPerfRow').onclick  = () => { addPerfRow(); renderPerfTable(); };
$('clearPerf').onclick   = () => { perfRows = []; renderPerfTable(); updateTotals(); updateSummary(); };
$('genSummary').onclick  = () => { updateTotals(); updateSummary(); };

function addPerfRow(initial){
  perfRows.push({
    name: initial?.name || '',
    email: initial?.email || '',
    sales: initial?.sales || 0,
    cash: initial?.cash || 0,
    calls: initial?.calls || 0,
    msgs: initial?.msgs || 0
  });
}

function renderPerfTable(){
  const tbody = $('perfBody');
  tbody.innerHTML = '';

  perfRows.forEach((row,idx) => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><input class="perf" data-field="name"  data-idx="${idx}" value="${row.name}"></td>
      <td><input class="perf" data-field="email" data-idx="${idx}" value="${row.email}"></td>
      <td><input class="perf" data-field="sales" data-idx="${idx}" type="number" min="0" value="${row.sales}"></td>
      <td><input class="perf" data-field="cash"  data-idx="${idx}" type="number" min="0" step="0.01" value="${row.cash}"></td>
      <td><input class="perf" data-field="calls" data-idx="${idx}" type="number" min="0" value="${row.calls}"></td>
      <td><input class="perf" data-field="msgs"  data-idx="${idx}" type="number" min="0" value="${row.msgs}"></td>
      <td id="conv-${idx}">0%</td>
      <td><button class="btn sec" data-del="${idx}">âœ–</button></td>
    `;
    tbody.appendChild(tr);
  });

  // listeners de inputs
  tbody.querySelectorAll('input.perf').forEach(inp => {
    inp.oninput = () => {
      const idx = Number(inp.getAttribute('data-idx'));
      const field = inp.getAttribute('data-field');
      let value = inp.value;
      if(['sales','cash','calls','msgs'].includes(field)){
        value = Number(value || 0);
      }
      perfRows[idx][field] = value;
      updateTotals();
      updateRowConv(idx);
      updateSummary();
    };
  });

  // botones borrar
  tbody.querySelectorAll('button[data-del]').forEach(btn => {
    btn.onclick = () => {
      const idx = Number(btn.getAttribute('data-del'));
      perfRows.splice(idx,1);
      renderPerfTable();
      updateTotals();
      updateSummary();
    };
  });

  // actualizar conversiones
  perfRows.forEach((_r,i)=>updateRowConv(i));
  updateTotals();
  updateSummary();
}

function updateRowConv(idx){
  const row = perfRows[idx];
  const denom = (Number(row.calls)||0) + (Number(row.msgs)||0);
  const sales = Number(row.sales)||0;
  const conv = denom>0 ? (sales/denom*100) : 0;
  const cell = $('conv-'+idx);
  if(cell) cell.textContent = conv.toFixed(1) + '%';
}

function updateTotals(){
  let totSales = 0, totCash = 0, totCalls = 0, totMsgs = 0;
  perfRows.forEach(r=>{
    totSales += Number(r.sales)||0;
    totCash  += Number(r.cash)||0;
    totCalls += Number(r.calls)||0;
    totMsgs  += Number(r.msgs)||0;
  });
  const denom = totCalls + totMsgs;
  const convGlobal = denom>0 ? (totSales/denom*100) : 0;

  $('totSales').textContent = totSales;
  $('totCash').textContent  = totCash.toFixed ? totCash.toFixed(2) : totCash;
  $('totCalls').textContent = totCalls;
  $('totMsgs').textContent  = totMsgs;
  $('totConv').textContent  = convGlobal.toFixed(1) + '%';
}

function updateSummary(){
  const date = ($('datePerf').value || '').trim() || '(sin fecha)';
  const cur  = ($('currency').value || '$').trim() || '$';

  let totSales = 0, totCash = 0, totCalls = 0, totMsgs = 0;
  perfRows.forEach(r=>{
    totSales += Number(r.sales)||0;
    totCash  += Number(r.cash)||0;
    totCalls += Number(r.calls)||0;
    totMsgs  += Number(r.msgs)||0;
  });
  const denom = totCalls + totMsgs;
  const convGlobal = denom>0 ? (totSales/denom*100) : 0;

  let lines = [];
  lines.push(`Cierre comercial ${date}`);
  lines.push('');
  lines.push(`â€¢ Ventas totales: ${totSales}`);
  lines.push(`â€¢ Cash total: ${cur}${totCash.toFixed ? totCash.toFixed(2) : totCash}`);
  lines.push(`â€¢ Llamadas atendidas: ${totCalls}`);
  lines.push(`â€¢ Mensajes atendidos: ${totMsgs}`);
  lines.push(`â€¢ ConversiÃ³n global: ${convGlobal.toFixed(1)}%`);
  lines.push('');
  if(perfRows.length){
    lines.push('Por asesor:');
    perfRows.forEach(r=>{
      const calls = Number(r.calls)||0;
      const msgs  = Number(r.msgs)||0;
      const s     = Number(r.sales)||0;
      const d     = calls+msgs;
      const conv  = d>0 ? (s/d*100) : 0;
      lines.push(`â€“ ${r.name || '(sin nombre)'}: ${s} ventas Â· ${cur}${(Number(r.cash)||0).toFixed(2)} Â· ${calls} llamadas Â· ${msgs} mensajes Â· ${conv.toFixed(1)}%`);
    });
  }

  $('summaryText').value = lines.join('\n');
}

// Inicial: sin filas, pero render vacÃ­o
renderPerfTable();
</script>
</body>
</html>
