<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sales never sleep ‚Äî Turnos & M√©tricas</title>
<style>
:root{
  --bg:#020617;
  --panel:#0b1120;
  --edge:#1f2933;
  --text:#e5e7eb;
  --mut:#9ca3af;
  --acc:#facc15;
  --acc2:#22c55e;
  --bad:#ef4444;
  --ok:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at 0 0,rgba(250,204,21,.1),transparent 55%),
             radial-gradient(circle at 100% 0,rgba(34,197,94,.1),transparent 55%),
             var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
}
.wrap{
  max-width:1120px;
  margin:0 auto;
  padding:24px 16px 40px;
}
header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  margin-bottom:16px;
}
h1{
  margin:0;
  font-size:26px;
  font-weight:900;
  letter-spacing:.16em;
  text-transform:uppercase;
}
.sub{color:var(--mut);font-size:12px}
.hero-sub{margin-top:6px;font-size:13px;color:#e5e7eb}

/* Banner */
.bf-banner{
  margin:12px 0 16px;
  padding:10px 14px;
  border-radius:12px;
  border:1px dashed rgba(250,204,21,.7);
  background:#020617;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.bf-pill{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.12em;
  padding:6px 10px;
  border-radius:999px;
  background:linear-gradient(90deg,var(--acc),var(--acc2));
  color:#111827;
}
.bf-copy{font-size:13px;color:#f9fafb}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{
  border:1px solid var(--edge);
  background:#020617;
  color:#d1d5db;
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
}
.tab.on{
  border-color:rgba(250,204,21,.7);
  color:#fefce8;
}

/* Cards */
.card{
  background:#020617;
  border:1px solid var(--edge);
  border-radius:14px;
  padding:16px;
}
.grid5{
  display:grid;
  grid-template-columns:repeat(5,minmax(0,1fr));
  gap:10px;
}
.grid3{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:10px;
}
.lbl{
  font-size:12px;
  color:var(--mut);
  margin-bottom:4px;
}
.inp,select{
  background:#020617;
  color:var(--text);
  border:1px solid #1f2933;
  border-radius:10px;
  padding:10px;
  width:100%;
  font-size:13px;
}

/* Tag */
.tag{
  margin-left:6px;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
}

/* Horas */
.hours{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:8px;
  margin-top:6px;
}
.hbtn{
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #1f2933;
  border-radius:10px;
  cursor:pointer;
  user-select:none;
  background:#020617;
  font-size:13px;
}
.hbtn.on{
  background:linear-gradient(180deg,var(--acc),var(--acc2));
  color:#111827;
  border-color:rgba(250,204,21,.8);
}

/* Acciones */
.actions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:14px;
}
.btn{
  background:linear-gradient(180deg,var(--acc),var(--acc2));
  color:#062e15;
  font-weight:700;
  border:none;
  border-radius:10px;
  padding:10px 14px;
  cursor:pointer;
  font-size:13px;
}
.btn.sec{
  background:#020617;
  color:#cbd5e1;
  border:1px solid #1f2933;
}
.msg{font-size:12px}
.ok{color:#22c55e}
.err{color:#ef4444}
.mut{color:#9ca3af}

/* Chips d√≠as */
.chips{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:6px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #24303a;
  background:#020617;
  font-size:12px;
}
.chip button{
  background:transparent;
  border:none;
  color:#93a3b3;
  cursor:pointer;
}

/* Tabla */
.table{
  margin-top:10px;
  border-collapse:collapse;
  width:100%;
  font-size:13px;
}
th,td{
  border:1px solid #1f2730;
  padding:6px 8px;
}
th{background:#020617;text-align:left}

/* KPI */
.kpi{
  border:1px solid #223;
  background:#020617;
  border-radius:12px;
  padding:14px;
  text-align:center;
}
.kpi h3{margin:0;font-size:13px;color:#a7f3d0}
.kpi .v{font-size:24px;font-weight:900;margin-top:6px}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
}
.modal .box{
  width:min(480px,92%);
  background:#020617;
  border:1px solid #223;
  border-radius:14px;
  padding:16px;
}
.box h3{margin:0 0 8px;font-size:16px}
.list{font-size:14px;line-height:1.6;margin:6px 0 12px;color:#e5e7eb}
.row{display:flex;gap:8px;justify-content:flex-end}

@media(max-width:960px){
  .grid5{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media(max-width:640px){
  header{flex-direction:column;align-items:flex-start}
  .grid5,.grid3{grid-template-columns:minmax(0,1fr)}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Sales never sleep</h1>
      <div class="hero-sub">Del primer ping al √∫ltimo pago: agenda tus turnos y no dejes ventas dormidas.</div>
      <div class="sub">
        En Black Friday (28 nov ‚Äì 1 dic) horario extendido <b>7:00 a. m. ‚Üí 3:00 a. m.</b>.
        Resto de d√≠as <b>9:00 a. m. ‚Üí 9:00 p. m.</b> (m√≠n 3h/d√≠a, m√°x 3 d√≠as por registro).
      </div>
    </div>
    <div class="sub">Capacidad fija: <b>30</b> msgs/h</div>
  </header>

  <div class="bf-banner">
    <div class="bf-pill">Black Friday Ops</div>
    <div class="bf-copy">
      28, 29, 30 de noviembre y 1 de diciembre son d√≠as clave. Asegura tus slots y atrapa cada oportunidad. üí∏‚ö°
    </div>
  </div>

  <div class="tabs">
    <button class="tab on" id="tShift">Programar turno</button>
    <button class="tab" id="tMetrics">Mis m√©tricas</button>
  </div>

  <!-- Secci√≥n turnos -->
  <section class="card" id="shiftSec">
    <div class="grid5">
      <div>
        <div class="lbl">Selecciona un d√≠a</div>
        <input class="inp" type="date" id="datePick">
      </div>
      <div style="align-self:end">
        <button class="btn sec" id="addDay">Agregar d√≠a</button>
      </div>
      <div>
        <div class="lbl">Nombre</div>
        <input class="inp" id="name" placeholder="Tu nombre">
      </div>
      <div>
        <div class="lbl">Email</div>
        <input class="inp" id="email" placeholder="tu@correo.com">
      </div>
      <div>
        <div class="lbl">Canal</div>
        <select id="channel" class="inp">
          <option value="mensajes">mensajes</option>
          <option value="llamadas">llamadas</option>
          <option value="ambos">ambos</option>
        </select>
      </div>
    </div>

    <div class="lbl" style="margin-top:8px">D√≠as seleccionados (m√°ximo 3)</div>
    <div class="chips" id="days"></div>

    <div style="margin-top:12px">
      <div class="lbl">
        Horas para el d√≠a activo <span id="activeDayLabel" class="mut"></span>
        <span id="dayModeLabel" class="tag"></span> (m√≠nimo 3)
      </div>
      <div class="hours" id="hours"></div>
    </div>

    <div class="actions">
      <button class="btn" id="save">Validar y guardar</button>
      <button class="btn sec" id="viewMyShifts">Ver mis turnos</button>
      <span id="msg" class="msg"></span>
    </div>

    <div class="sub" style="margin-top:8px">
      Tus turnos guardados para el email ingresado
      <span class="mut">(si hay d√≠as seleccionados, se filtrar√° a esos d√≠as; si no, ver√°s todo el mes actual).</span>
    </div>
    <table class="table" id="myTbl">
      <thead>
        <tr><th>Fecha</th><th>Hora</th><th>Canal</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Secci√≥n m√©tricas -->
  <section class="card" id="metricsSec" style="display:none">
    <div class="grid5">
      <div>
        <div class="lbl">Mes (AAAA-MM)</div>
        <input class="inp" id="month" placeholder="2025-11">
      </div>
      <div>
        <div class="lbl">Tu email</div>
        <input class="inp" id="memail" placeholder="tu@correo.com">
      </div>
      <div style="align-self:end">
        <button class="btn" id="mload">Ver acumulado</button>
      </div>
    </div>

    <div class="msg" id="mmsg" style="margin-top:8px"></div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Asignadas</h3><div class="v" id="k_assigned">0</div></div>
      <div class="kpi"><h3>Atendidas</h3><div class="v" id="k_attended">0</div></div>
      <div class="kpi"><h3>Cerradas</h3><div class="v" id="k_closed">0</div></div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Links enviados</h3><div class="v" id="k_sent">0</div></div>
      <div class="kpi"><h3>Links pagados</h3><div class="v" id="k_paid">0</div></div>
      <div class="kpi"><h3>Ventas</h3><div class="v" id="k_sales">0</div></div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Conv. / Atendidas</h3><div class="v" id="k_cvr1">0%</div></div>
      <div class="kpi"><h3>Conv. / Links enviados</h3><div class="v" id="k_cvr2">0%</div></div>
      <div class="kpi"><h3>Conv. / Links pagados</h3><div class="v" id="k_cvr3">0%</div></div>
    </div>
  </section>
</div>

<!-- Modal -->
<div class="modal" id="confirmModal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Confirma tus turnos</h3>
    <div class="list" id="confirmList"></div>
    <div class="row">
      <button class="btn sec" id="cancelConfirm">Cancelar</button>
      <button class="btn" id="acceptConfirm">Aceptar y guardar</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://wbplsmimcuphytdfjapz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:false}});
const CSV_BASE_URL="https://fsalas-ship-it.github.io/agent-shift-planner/monthly";

const $=id=>document.getElementById(id);
const tShift=$('tShift'),tMetrics=$('tMetrics');
const shiftSec=$('shiftSec'),metricsSec=$('metricsSec');

tShift.onclick=()=>{tShift.classList.add('on');tMetrics.classList.remove('on');shiftSec.style.display='block';metricsSec.style.display='none';};
tMetrics.onclick=()=>{tMetrics.classList.add('on');tShift.classList.remove('on');shiftSec.style.display='none';metricsSec.style.display='block';};

function toast(kind,msg){ const el=$('msg'); el.className='msg '+(kind||'mut'); el.textContent=msg; }

const FIXED_CAP=30;

/* Horarios */
const NORMAL_HOURS=[9,10,11,12,13,14,15,16,17,18,19,20,21];
const EXTENDED_HOURS=[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3];
const BF_DAYS=['11-28','11-29','11-30','12-01'];

function isBfDay(dateStr){
  if(!dateStr)return false;
  return BF_DAYS.includes(dateStr.slice(5));
}
function getHoursForDay(dateStr){
  return isBfDay(dateStr)?EXTENDED_HOURS:NORMAL_HOURS;
}

let activeDay=null;
const selectedDays=[];
const hoursByDay={};

(function initDates(){
  const d=new Date();
  const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('datePick').value=iso;
  setActiveDay(iso,true);
})();

function updateDayModeLabel(){
  const label=$('dayModeLabel');
  if(!activeDay){label.textContent='';return;}
  label.textContent=isBfDay(activeDay)?'BF 7am ‚Üí 3am':'Horario 9am ‚Üí 9pm';
}

function setActiveDay(date,ensureAdded=false){
  activeDay=date;
  $('activeDayLabel').textContent=activeDay?`(${activeDay})`:'';
  if(ensureAdded && !selectedDays.includes(date)) addDay(date);
  renderDays();
  updateDayModeLabel();
  paintHours();
}

function addDay(date){
  if(!date)return;
  if(selectedDays.includes(date))return setActiveDay(date);
  if(selectedDays.length>=3){return toast('err','M√°ximo 3 d√≠as por registro.');}
  selectedDays.push(date);
  hoursByDay[date]=hoursByDay[date]||new Set();
  setActiveDay(date);
}

function removeDay(date){
  const i=selectedDays.indexOf(date);
  if(i>=0){
    selectedDays.splice(i,1);
    delete hoursByDay[date];
  }
  if(selectedDays.length){setActiveDay(selectedDays[0]);}
  else{activeDay=null;paintHours();renderDays();updateDayModeLabel();}
}

$('addDay').onclick=()=>{
  const d=$('datePick').value;
  if(!d){toast('err','Selecciona un d√≠a.');return;}
  addDay(d);
};

function renderDays(){
  const box=$('days');
  box.innerHTML='';
  selectedDays.forEach(d=>{
    const el=document.createElement('span');
    el.className='chip';
    const badge=isBfDay(d)?' <span style="font-size:10px;color:#facc15;">BF</span>':'';
    el.innerHTML=`${d} ${d===activeDay?'<b>(activo)</b>':''}${badge}
      <button data-sel="${d}">‚óè</button>
      <button data-del="${d}">√ó</button>`;
    box.appendChild(el);
  });
  box.querySelectorAll('button[data-sel]').forEach(b=>b.onclick=()=>setActiveDay(b.getAttribute('data-sel')));
  box.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>removeDay(b.getAttribute('data-del')));
}

function paintHours(){
  const box=$('hours');
  box.innerHTML='';
  if(!activeDay){
    box.innerHTML='<div class="mut">Primero agrega un d√≠a.</div>';
    return;
  }
  const sel=hoursByDay[activeDay]||(hoursByDay[activeDay]=new Set());
  const list=getHoursForDay(activeDay);
  list.forEach(h=>{
    const d=document.createElement('div');
    d.className='hbtn'+(sel.has(h)?' on':'');
    d.textContent=`${String(h).padStart(2,'0')}:00`;
    d.onclick=()=>{
      sel.has(h)?sel.delete(h):sel.add(h);
      paintHours();
    };
    box.appendChild(d);
  });
}

$('save').onclick=async ()=>{
  const name=$('name').value.trim();
  const email=$('email').value.trim();
  const channel=$('channel').value;
  if(!name||!email){return toast('err','Escribe tu nombre y email.');}
  if(selectedDays.length===0){return toast('err','Agrega al menos 1 d√≠a.');}
  for(const d of selectedDays){
    if((hoursByDay[d]||new Set()).size<3){
      return toast('err',`El d√≠a ${d} tiene menos de 3 horas.`);
    }
  }

  const lines=selectedDays.map(d=>{
    const arr=Array.from(hoursByDay[d]||[])
      .sort((a,b)=>a-b)
      .map(h=>`${String(h).padStart(2,'0')}:00`).join(', ');
    return `<li><b>${d}</b> ‚Äî ${arr}</li>`;
  }).join('');

  $('confirmList').innerHTML=`
    <p>
      <b>Nombre:</b> ${name}<br>
      <b>Email:</b> ${email}<br>
      <b>Canal:</b> ${channel}<br>
      <b>Capacidad:</b> ${FIXED_CAP} msgs/h
    </p>
    <ul>${lines}</ul>
  `;
  showConfirm(true);

  $('acceptConfirm').onclick=async ()=>{
    showConfirm(false);
    toast('mut','Guardando‚Ä¶');
    const rows=[];
    selectedDays.forEach(d=>{
      (hoursByDay[d]||new Set()).forEach(h=>{
        rows.push({date:d,hour:h,name,email,channel,cap_msg:FIXED_CAP});
      });
    });
    try{
      const {error,status}=await sb
        .from('bookings')
        .upsert(rows,{onConflict:'date,hour,email',ignoreDuplicates:false,defaultToNull:true});
      if(error){return toast('err',`Error (${status||'‚Äî'}): ${error.message}`);}
      toast('ok','Turnos guardados ‚úîÔ∏è');
      selectedDays.splice(0,selectedDays.length);
      for(const k in hoursByDay)delete hoursByDay[k];
      renderDays();
      paintHours();
      updateDayModeLabel();
      loadMyShifts();
    }catch(e){
      toast('err','Excepci√≥n: '+(e?.message||String(e)));
    }
  };
};

$('cancelConfirm').onclick=()=>showConfirm(false);
function showConfirm(f){$('confirmModal').style.display=f?'flex':'none';}

/* Ver mis turnos */
async function loadMyShifts(){
  const email=($('email').value||'').trim();
  if(!email){toast('err','Escribe tu email para ver tus turnos.');return;}
  const tb=$('myTbl').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="3">Cargando‚Ä¶</td></tr>';

  try{
    let query=sb.from('bookings')
      .select('date,hour,channel,email')
      .ilike('email',email);

    if(selectedDays.length>0){
      query=query.in('date',selectedDays);
    }else{
      const d=new Date();
      const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      query=query.gte('date',ym+'-01').lte('date',ym+'-31');
    }

    const {data,error}=await query.order('date').order('hour');
    tb.innerHTML='';
    if(error){
      tb.innerHTML=`<tr><td colspan="3">Error: ${error.message}</td></tr>`;
      return;
    }
    if(!data||!data.length){
      tb.innerHTML='<tr><td colspan="3">No tienes turnos registrados con ese email en el rango seleccionado.</td></tr>';
      return;
    }
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${String(r.hour).padStart(2,'0')}:00</td><td>${r.channel||'‚Äî'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML=`<tr><td colspan="3">Excepci√≥n: ${(e?.message||String(e))}</td></tr>`;
  }
}

$('email').addEventListener('change', loadMyShifts);
$('viewMyShifts').onclick=loadMyShifts;

/* M√©tricas MTD */
function toNum(v){
  const n=Number(String(v).replace(/[^0-9.-]/g,''));
  return isFinite(n)?n:0;
}
async function fetchCSV(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok)throw new Error("HTTP "+r.status);
  const t=await r.text();
  return new Promise((res,rej)=>Papa.parse(t,{header:true,skipEmptyLines:true,complete:x=>res(x.data),error:rej}));
}
function pct(x){return (x*100).toFixed(1)+'%';}
function safeDiv(a,b){return b>0?a/b:0;}
function findHeader(headers,needle){
  const n=needle.toLowerCase();
  return headers.find(h=>h.toLowerCase().includes(n))||null;
}

$('mload').onclick=async ()=>{
  const month=($('month').value||'').trim();
  const email=($('memail').value||'').trim().toLowerCase();
  if(!month||!email){
    $('mmsg').className='msg err';
    $('mmsg').textContent='Escribe mes y email.';
    return;
  }
  $('mmsg').className='msg mut';
  $('mmsg').textContent='Cargando‚Ä¶';
  try{
    const url=`${CSV_BASE_URL}/${month}.csv`;
    const rows=await fetchCSV(url);
    if(!rows.length)throw new Error('CSV sin filas');
    const headers=Object.keys(rows[0]||{});
    const emailCol=headers.find(h=>/email/i.test(h))||headers[0];
    const mine=rows.filter(r=>String(r[emailCol]||'').toLowerCase()===email);
    if(!mine.length){
      $('mmsg').className='msg err';
      $('mmsg').textContent='No hay registros para ese email.';
      return;
    }
    const colAssigned=findHeader(headers,'conv. gestionadas');
    const colClosed=findHeader(headers,'conv. cerrad');
    const colSent=findHeader(headers,'usuarios a quien se envio link de pago');
    const colTxn=findHeader(headers,'txn atribuida');
    const sum=col=>mine.reduce((a,r)=>a+toNum(r[col]??0),0);
    const assigned=colAssigned?sum(colAssigned):0;
    const attended=assigned;
    const closed=colClosed?sum(colClosed):0;
    const sent=colSent?sum(colSent):0;
    const paid=colTxn?sum(colTxn):0;
    const sales=paid;

    $('k_assigned').textContent=assigned;
    $('k_attended').textContent=attended;
    $('k_closed').textContent=closed;
    $('k_sent').textContent=sent;
    $('k_paid').textContent=paid;
    $('k_sales').textContent=sales;
    $('k_cvr1').textContent=pct(safeDiv(sales,attended));
    $('k_cvr2').textContent=pct(safeDiv(sales,sent));
    $('k_cvr3').textContent=pct(safeDiv(sales,paid));
    $('mmsg').className='msg ok';
    $('mmsg').textContent='Listo ‚úîÔ∏è';
  }catch(e){
    $('mmsg').className='msg err';
    $('mmsg').textContent='Error: '+(e?.message||String(e));
  }
};
</script>
</body>
</html>

