<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Navidad de Ventas ‚Äî Turnos & M√©tricas</title>
<style>
:root{
  --bg:#020617;
  --panel:#020617;
  --edge:#1f2937;
  --text:#e5e7eb;
  --mut:#9ca3af;
  --acc:#22c55e;
  --acc2:#16a34a;
  --accent-red:#f97373;
  --bad:#ef4444;
  --ok:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at 0 0,rgba(248,113,113,.15),transparent 60%),
    radial-gradient(circle at 100% 0,rgba(34,197,94,.18),transparent 60%),
    radial-gradient(circle at 50% 100%,rgba(56,189,248,.16),transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  overflow-x:hidden;
}
.wrap{
  max-width:1120px;
  margin:0 auto;
  padding:24px 16px 40px;
  position:relative;
}

/* ‚Äúluces‚Äù navide√±as arriba */
.lights{
  position:absolute;
  inset:0 0 auto 0;
  height:48px;
  pointer-events:none;
  display:flex;
  justify-content:center;
  gap:18px;
}
.light{
  width:8px;
  height:16px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 0,#fff,rgba(248,250,252,.1));
  box-shadow:0 0 14px rgba(248,250,252,.6);
  animation:twinkle 1.6s ease-in-out infinite;
}
.light:nth-child(3n){background:#f97373;box-shadow:0 0 12px rgba(248,113,113,.9);}
.light:nth-child(3n+1){background:#4ade80;box-shadow:0 0 12px rgba(74,222,128,.9);}
.light:nth-child(3n+2){background:#facc15;box-shadow:0 0 12px rgba(250,204,21,.9);}
.light:nth-child(4n){animation-delay:.3s}
.light:nth-child(5n){animation-delay:.6s}
@keyframes twinkle{
  0%,100%{opacity:.5;transform:translateY(0)}
  50%{opacity:1;transform:translateY(2px)}
}

header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  margin-top:32px;
  margin-bottom:16px;
}
h1{
  margin:0;
  font-size:26px;
  font-weight:900;
  letter-spacing:.16em;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:10px;
}
h1 span.emoji{
  font-size:24px;
}
.hero-sub{
  margin-top:6px;
  font-size:13px;
  color:#e5e7eb;
}
.sub{color:var(--mut);font-size:12px}

/* Banner navide√±o */
.bf-banner{
  margin:10px 0 16px;
  padding:10px 14px;
  border-radius:14px;
  border:1px solid rgba(248,250,252,.08);
  background:linear-gradient(145deg,rgba(34,197,94,.22),rgba(15,23,42,.98));
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.bf-pill{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.16em;
  padding:6px 10px;
  border-radius:999px;
  background:radial-gradient(circle at 0 0,#f97373,#fb923c);
  color:#111827;
}
.bf-copy{font-size:13px;color:#f9fafb}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{
  border:1px solid var(--edge);
  background:rgba(15,23,42,.9);
  color:#d1d5db;
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.tab.on{
  border-color:rgba(34,197,94,.8);
  box-shadow:0 0 0 1px rgba(34,197,94,.4) inset;
  color:#fefce8;
}

/* Cards */
.card{
  background:radial-gradient(circle at 0 0,rgba(148,163,184,.16),transparent 55%),
             rgba(15,23,42,.96);
  border:1px solid var(--edge);
  border-radius:16px;
  padding:16px;
}
.grid5{
  display:grid;
  grid-template-columns:repeat(5,minmax(0,1fr));
  gap:10px;
}
.grid3{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:10px;
}
.lbl{
  font-size:12px;
  color:var(--mut);
  margin-bottom:4px;
}
.inp,select{
  background:#020617;
  color:var(--text);
  border:1px solid #1f2937;
  border-radius:10px;
  padding:10px;
  width:100%;
  font-size:13px;
}

/* Chips d√≠as */
.chips{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:6px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid #24303a;
  background:#020617;
  font-size:12px;
}
.chip button{
  background:transparent;
  border:none;
  color:#93a3b3;
  cursor:pointer;
}

/* Horas */
.hours{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:8px;
  margin-top:6px;
  position:relative;
}
.hbtn{
  position:relative;
  height:42px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #1f2937;
  border-radius:10px;
  cursor:pointer;
  user-select:none;
  background:radial-gradient(circle at 0 0,rgba(248,250,252,.08),transparent 55%),
             #020617;
  font-size:13px;
  transition:transform .12s ease-out,box-shadow .12s ease-out,border-color .12s ease-out,background .12s ease-out;
}
.hbtn:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 16px rgba(15,23,42,.9);
  border-color:#4ade80;
}
.hbtn.on{
  background:linear-gradient(145deg,#4ade80,#22c55e);
  color:#052e16;
  border-color:#bbf7d0;
  box-shadow:0 0 18px rgba(34,197,94,.5);
}

/* Money burst */
.money-burst{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  animation:moneyFloat .7s ease-out forwards;
  pointer-events:none;
  font-size:18px;
}
@keyframes moneyFloat{
  0%{transform:translate(-50%,-10%) scale(1);opacity:1}
  60%{transform:translate(-50%,-40%) scale(1.3);opacity:1}
  100%{transform:translate(-50%,-60%) scale(0.8);opacity:0}
}

/* Acciones */
.actions{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:14px;
}
.btn{
  background:linear-gradient(145deg,#22c55e,#16a34a);
  color:#052e16;
  font-weight:700;
  border:none;
  border-radius:10px;
  padding:10px 14px;
  cursor:pointer;
  font-size:13px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn.sec{
  background:#020617;
  color:#cbd5e1;
  border:1px solid #1f2937;
}
.msg{font-size:12px}
.ok{color:#22c55e}
.err{color:#ef4444}
.mut{color:#9ca3af}

/* Tabla turnos */
.table{
  margin-top:10px;
  border-collapse:collapse;
  width:100%;
  font-size:13px;
}
th,td{
  border:1px solid #1f2937;
  padding:6px 8px;
}
th{background:#020617;text-align:left}

/* KPI */
.kpi{
  border:1px solid #223;
  background:#020617;
  border-radius:12px;
  padding:14px;
  text-align:center;
}
.kpi h3{margin:0;font-size:13px;color:#a7f3d0}
.kpi .v{font-size:24px;font-weight:900;margin-top:6px}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
}
.modal .box{
  width:min(480px,92%);
  background:#020617;
  border:1px solid #223;
  border-radius:14px;
  padding:16px;
}
.box h3{margin:0 0 8px;font-size:16px}
.list{font-size:14px;line-height:1.6;margin:6px 0 12px;color:#e5e7eb}
.row{display:flex;gap:8px;justify-content:flex-end}

@media(max-width:960px){
  .grid5{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media(max-width:640px){
  header{flex-direction:column;align-items:flex-start}
  .grid5,.grid3{grid-template-columns:minmax(0,1fr)}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="lights">
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
    <div class="light"></div><div class="light"></div><div class="light"></div>
  </div>

  <header>
    <div>
      <h1><span class="emoji">üéÑ</span> NAVIDAD DE VENTAS</h1>
      <div class="hero-sub">
        Agenda tus turnos, enciende las luces del chat y deja que caigan los üí∏.
      </div>
      <div class="sub">
        Turnos disponibles de <b>lunes a viernes</b>, entre <b>9:00 a. m.</b> y <b>9:00 p. m.</b> (m√≠n. 3h/d√≠a, m√°x. 3 d√≠as por registro).
      </div>
    </div>
    <div class="sub">Capacidad fija: <b>30</b> msgs/h</div>
  </header>

  <div class="bf-banner">
    <div class="bf-pill">Holiday Sales Mode</div>
    <div class="bf-copy">
      El mejor regalo es un funnel encendido: agenda tus horas fuertes para no dejar ning√∫n mensaje sin atender. üéÅ
    </div>
  </div>

  <div class="tabs">
    <button class="tab on" id="tShift">Programar turno</button>
    <button class="tab" id="tMetrics">Mis m√©tricas</button>
  </div>

  <!-- Secci√≥n turnos -->
  <section class="card" id="shiftSec">
    <div class="grid5">
      <div>
        <div class="lbl">Selecciona un d√≠a (lun‚Äìvie)</div>
        <input class="inp" type="date" id="datePick">
      </div>
      <div style="align-self:end">
        <button class="btn sec" id="addDay">Agregar d√≠a</button>
      </div>
      <div>
        <div class="lbl">Nombre</div>
        <input class="inp" id="name" placeholder="Tu nombre">
      </div>
      <div>
        <div class="lbl">Email</div>
        <input class="inp" id="email" placeholder="tu@correo.com">
      </div>
      <div>
        <div class="lbl">Canal</div>
        <select id="channel" class="inp">
          <option value="mensajes">mensajes</option>
          <option value="llamadas">llamadas</option>
          <option value="ambos">ambos</option>
        </select>
      </div>
    </div>

    <div class="lbl" style="margin-top:8px">D√≠as seleccionados (m√°ximo 3)</div>
    <div class="chips" id="days"></div>

    <div style="margin-top:12px">
      <div class="lbl">
        Horas para el d√≠a activo <span id="activeDayLabel" class="mut"></span> (m√≠nimo 3)
      </div>
      <div class="hours" id="hours"></div>
    </div>

    <div class="actions">
      <button class="btn" id="save">Validar y guardar</button>
      <button class="btn sec" id="viewMyShifts">Ver mis turnos</button>
      <span id="msg" class="msg"></span>
    </div>

    <div class="sub" style="margin-top:8px">
      Tus turnos guardados para el email ingresado
      <span class="mut">(si hay d√≠as seleccionados, se filtrar√° a esos d√≠as; si no, ver√°s todo el mes actual).</span>
    </div>
    <table class="table" id="myTbl">
      <thead>
        <tr><th>Fecha</th><th>Hora</th><th>Canal</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Secci√≥n m√©tricas -->
  <section class="card" id="metricsSec" style="display:none">
    <div class="grid5">
      <div>
        <div class="lbl">Mes (AAAA-MM)</div>
        <input class="inp" id="month" placeholder="2025-12">
      </div>
      <div>
        <div class="lbl">Tu email</div>
        <input class="inp" id="memail" placeholder="tu@correo.com">
      </div>
      <div style="align-self:end">
        <button class="btn" id="mload">Ver acumulado</button>
      </div>
    </div>

    <div class="msg" id="mmsg" style="margin-top:8px"></div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Asignadas</h3><div class="v" id="k_assigned">0</div></div>
      <div class="kpi"><h3>Atendidas</h3><div class="v" id="k_attended">0</div></div>
      <div class="kpi"><h3>Cerradas</h3><div class="v" id="k_closed">0</div></div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Links enviados</h3><div class="v" id="k_sent">0</div></div>
      <div class="kpi"><h3>Links pagados</h3><div class="v" id="k_paid">0</div></div>
      <div class="kpi"><h3>Ventas</h3><div class="v" id="k_sales">0</div></div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi"><h3>Conv. / Atendidas</h3><div class="v" id="k_cvr1">0%</div></div>
      <div class="kpi"><h3>Conv. / Links enviados</h3><div class="v" id="k_cvr2">0%</div></div>
      <div class="kpi"><h3>Conv. / Links pagados</h3><div class="v" id="k_cvr3">0%</div></div>
    </div>
  </section>
</div>

<!-- Modal confirmaci√≥n -->
<div class="modal" id="confirmModal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Confirma tus turnos</h3>
    <div class="list" id="confirmList"></div>
    <div class="row">
      <button class="btn sec" id="cancelConfirm">Cancelar</button>
      <button class="btn" id="acceptConfirm">Aceptar y guardar</button>
    </div>
  </div>
</div>

<script>
// === Supabase & CSV config ===
const SUPABASE_URL="https://wbplsmimcuphytdfjapz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:false}});
const CSV_BASE_URL="https://fsalas-ship-it.github.io/agent-shift-planner/monthly";

const $=id=>document.getElementById(id);
const tShift=$('tShift'),tMetrics=$('tMetrics');
const shiftSec=$('shiftSec'),metricsSec=$('metricsSec');

tShift.onclick=()=>{tShift.classList.add('on');tMetrics.classList.remove('on');shiftSec.style.display='block';metricsSec.style.display='none';};
tMetrics.onclick=()=>{tMetrics.classList.add('on');tShift.classList.remove('on');shiftSec.style.display='none';metricsSec.style.display='block';};

function toast(kind,msg){ const el=$('msg'); el.className='msg '+(kind||'mut'); el.textContent=msg; }

const FIXED_CAP=30;
const HOURS=[9,10,11,12,13,14,15,16,17,18,19,20,21]; // 9:00 a 21:00

let activeDay=null;
const selectedDays=[];
const hoursByDay={};

// Fecha inicial = hoy
(function initDates(){
  const d=new Date();
  const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('datePick').value=iso;
  setActiveDay(iso,true);
})();

// Solo lunes a viernes
function isWeekday(dateStr){
  if(!dateStr) return false;
  const d=new Date(dateStr+'T00:00:00');
  const day=d.getUTCDay(); // 0=domingo, 6=s√°bado
  return day>=1 && day<=5;
}

function setActiveDay(date,ensureAdded=false){
  activeDay=date;
  $('activeDayLabel').textContent=activeDay?`(${activeDay})`:'';
  if(ensureAdded && !selectedDays.includes(date)) addDay(date);
  renderDays();
  paintHours();
}

function addDay(date){
  if(!date) return;
  if(!isWeekday(date)){
    toast('err','Solo puedes agendar turnos de lunes a viernes.');
    return;
  }
  if(selectedDays.includes(date)) return setActiveDay(date);
  if(selectedDays.length>=3){ return toast('err','M√°ximo 3 d√≠as por registro.'); }
  selectedDays.push(date);
  hoursByDay[date]=hoursByDay[date]||new Set();
  setActiveDay(date);
}

function removeDay(date){
  const i=selectedDays.indexOf(date);
  if(i>=0){
    selectedDays.splice(i,1);
    delete hoursByDay[date];
  }
  if(selectedDays.length){ setActiveDay(selectedDays[0]); }
  else { activeDay=null; paintHours(); renderDays(); }
}

$('addDay').onclick=()=>{
  const d=$('datePick').value;
  if(!d){toast('err','Selecciona un d√≠a.');return;}
  addDay(d);
};

function renderDays(){
  const box=$('days');
  box.innerHTML='';
  selectedDays.forEach(d=>{
    const el=document.createElement('span');
    el.className='chip';
    el.innerHTML=`${d} ${d===activeDay?'<b>(activo)</b>':''}
      <button data-sel="${d}">‚óè</button>
      <button data-del="${d}">√ó</button>`;
    box.appendChild(el);
  });
  box.querySelectorAll('button[data-sel]').forEach(b=> b.onclick=()=> setActiveDay(b.getAttribute('data-sel')) );
  box.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=> removeDay(b.getAttribute('data-del')) );
}

// money burst en click
function spawnMoney(el){
  const span=document.createElement('span');
  span.className='money-burst';
  span.textContent=Math.random()<0.5?'üí∏':'üí∞';
  el.appendChild(span);
  setTimeout(()=>{span.remove();},700);
}

function paintHours(){
  const box=$('hours');
  box.innerHTML='';
  if(!activeDay){
    box.innerHTML='<div class="mut">Primero agrega un d√≠a.</div>';
    return;
  }
  const sel=hoursByDay[activeDay]||(hoursByDay[activeDay]=new Set());
  HOURS.forEach(h=>{
    const d=document.createElement('div');
    d.className='hbtn'+(sel.has(h)?' on':'');
    d.textContent=`${String(h).padStart(2,'0')}:00`;
    d.onclick=()=>{
      if(sel.has(h)){ sel.delete(h); }
      else{ sel.add(h); spawnMoney(d); }
      d.classList.toggle('on');
    };
    box.appendChild(d);
  });
}

// Guardar turnos
$('save').onclick=async ()=>{
  const name=$('name').value.trim();
  const email=$('email').value.trim();
  const channel=$('channel').value;
  if(!name||!email){ return toast('err','Escribe tu nombre y email.'); }
  if(selectedDays.length===0){ return toast('err','Agrega al menos 1 d√≠a.'); }
  for(const d of selectedDays){
    if((hoursByDay[d]||new Set()).size<3){
      return toast('err',`El d√≠a ${d} tiene menos de 3 horas.`);
    }
  }

  const lines=selectedDays.map(d=>{
    const arr=Array.from(hoursByDay[d]||[])
      .sort((a,b)=>a-b)
      .map(h=>`${String(h).padStart(2,'0')}:00`)
      .join(', ');
    return `<li><b>${d}</b> ‚Äî ${arr}</li>`;
  }).join('');

  $('confirmList').innerHTML=`
    <p>
      <b>Nombre:</b> ${name}<br>
      <b>Email:</b> ${email}<br>
      <b>Canal:</b> ${channel}<br>
      <b>Capacidad:</b> ${FIXED_CAP} msgs/h
    </p>
    <ul>${lines}</ul>
  `;
  showConfirm(true);

  $('acceptConfirm').onclick=async ()=>{
    showConfirm(false);
    toast('mut','Guardando‚Ä¶');
    const rows=[];
    selectedDays.forEach(d=>{
      (hoursByDay[d]||new Set()).forEach(h=>{
        rows.push({date:d,hour:h,name,email,channel,cap_msg:FIXED_CAP});
      });
    });
    try{
      const {error,status}=await sb
        .from('bookings')
        .upsert(rows,{onConflict:'date,hour,email',ignoreDuplicates:false,defaultToNull:true});
      if(error){ return toast('err',`Error (${status||'‚Äî'}): ${error.message}`); }
      toast('ok','Turnos guardados ‚úîÔ∏è');
      selectedDays.splice(0,selectedDays.length);
      for(const k in hoursByDay) delete hoursByDay[k];
      renderDays();
      paintHours();
      loadMyShifts();
    }catch(e){
      toast('err','Excepci√≥n: '+(e?.message||String(e)));
    }
  };
};

$('cancelConfirm').onclick=()=>showConfirm(false);
function showConfirm(f){ $('confirmModal').style.display=f?'flex':'none'; }

// Ver mis turnos
async function loadMyShifts(){
  const email=($('email').value||'').trim();
  if(!email){
    toast('err','Escribe tu email para ver tus turnos.');
    return;
  }
  const tb=$('myTbl').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="3">Cargando‚Ä¶</td></tr>';

  try{
    let query=sb.from('bookings')
      .select('date,hour,channel,email')
      .ilike('email',email);

    if(selectedDays.length>0){
      query=query.in('date',selectedDays);
    }else{
      const d=new Date();
      const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      query=query.gte('date',ym+'-01').lte('date',ym+'-31');
    }

    const {data,error}=await query.order('date').order('hour');
    tb.innerHTML='';
    if(error){
      tb.innerHTML=`<tr><td colspan="3">Error: ${error.message}</td></tr>`;
      return;
    }
    if(!data||!data.length){
      tb.innerHTML='<tr><td colspan="3">No tienes turnos registrados con ese email en el rango seleccionado.</td></tr>';
      return;
    }
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${String(r.hour).padStart(2,'0')}:00</td><td>${r.channel||'‚Äî'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML=`<tr><td colspan="3">Excepci√≥n: ${(e?.message||String(e))}</td></tr>`;
  }
}
$('email').addEventListener('change', loadMyShifts);
$('viewMyShifts').onclick=loadMyShifts;

// === M√©tricas MTD ===
function toNum(v){
  const n=Number(String(v).replace(/[^0-9.-]/g,''));
  return isFinite(n)?n:0;
}
async function fetchCSV(url){
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  const t=await r.text();
  return new Promise((res,rej)=>Papa.parse(t,{header:true,skipEmptyLines:true,complete:x=>res(x.data),error:rej}));
}
function pct(x){return (x*100).toFixed(1)+'%';}
function safeDiv(a,b){return b>0?a/b:0;}
function findHeader(headers,needle){
  const n=needle.toLowerCase();
  return headers.find(h=>h.toLowerCase().includes(n))||null;
}

$('mload').onclick=async ()=>{
  const month=($('month').value||'').trim();
  const email=($('memail').value||'').trim().toLowerCase();
  if(!month||!email){
    $('mmsg').className='msg err';
    $('mmsg').textContent='Escribe mes y email.';
    return;
  }
  $('mmsg').className='msg mut';
  $('mmsg').textContent='Cargando‚Ä¶';
  try{
    const url=`${CSV_BASE_URL}/${month}.csv`;
    const rows=await fetchCSV(url);
    if(!rows.length) throw new Error('CSV sin filas');
    const headers=Object.keys(rows[0]||{});
    const emailCol=headers.find(h=>/email/i.test(h))||headers[0];
    const mine=rows.filter(r=>String(r[emailCol]||'').toLowerCase()===email);
    if(!mine.length){
      $('mmsg').className='msg err';
      $('mmsg').textContent='No hay registros para ese email.';
      return;
    }

    const colAssigned=findHeader(headers,'conv. gestionadas');
    const colClosed=findHeader(headers,'conv. cerrad');
    const colSent=findHeader(headers,'usuarios a quien se envio link de pago');
    const colTxn=findHeader(headers,'txn atribuida');

    const sum=col=>mine.reduce((a,r)=>a+toNum(r[col]??0),0);

    const assigned=colAssigned?sum(colAssigned):0;
    const attended=assigned;
    const closed=colClosed?sum(colClosed):0;
    const sent=colSent?sum(colSent):0;
    const paid=colTxn?sum(colTxn):0;
    const sales=paid;

    $('k_assigned').textContent=assigned;
    $('k_attended').textContent=attended;
    $('k_closed').textContent=closed;
    $('k_sent').textContent=sent;
    $('k_paid').textContent=paid;
    $('k_sales').textContent=sales;

    $('k_cvr1').textContent=pct(safeDiv(sales,attended));
    $('k_cvr2').textContent=pct(safeDiv(sales,sent));
    $('k_cvr3').textContent=pct(safeDiv(sales,paid));

    $('mmsg').className='msg ok';
    $('mmsg').textContent='Listo ‚úîÔ∏è';
  }catch(e){
    $('mmsg').className='msg err';
    $('mmsg').textContent='Error: '+(e?.message||String(e));
  }
};
</script>
</body>
</html>

