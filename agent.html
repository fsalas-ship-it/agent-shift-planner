<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Agente ‚Äî Turnos & M√©tricas (MTD)</title>
<style>
:root{
  --bg:#030712;
  --panel:#020617;
  --edge:#1f2937;
  --text:#e5e7eb;
  --mut:#9ca3af;
  --acc:#facc15;    /* amarillo promo */
  --acc2:#22c55e;   /* verde dinero */
  --bad:#ef4444;
  --ok:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(900px 500px at 0% 0%,rgba(250,204,21,.20),transparent 60%),
    radial-gradient(900px 600px at 100% 0%,rgba(34,197,94,.16),transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
.wrap{max-width:1120px;margin:0 auto;padding:28px}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px}
h1{margin:0;font-size:22px;font-weight:900}
.sub{color:var(--mut);font-size:12px}

/* Banner Black Friday */
.bf-banner{
  margin-bottom:16px;
  padding:12px 16px;
  border-radius:14px;
  border:1px dashed rgba(250,204,21,.7);
  background:
    radial-gradient(circle at 0 0,rgba(250,204,21,.20),transparent 55%),
    radial-gradient(circle at 100% 0,rgba(34,197,94,.22),transparent 55%),
    #020617;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.bf-pill{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.12em;
  padding:6px 12px;
  border-radius:999px;
  background:linear-gradient(90deg,var(--acc),var(--acc2));
  color:#111827;
  box-shadow:0 8px 20px rgba(0,0,0,.6);
}
.bf-copy{
  font-size:13px;
  color:#f9fafb;
}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{
  border:1px solid var(--edge);
  background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.7));
  color:#d1d5db;
  padding:10px 14px;
  border-radius:999px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
}
.tab::before{
  content:'';
  width:8px;
  height:8px;
  border-radius:999px;
  background:rgba(148,163,184,.5);
}
.tab.on{
  border-color:rgba(250,204,21,.9);
  color:#fefce8;
  box-shadow:0 0 0 1px rgba(250,204,21,.4) inset,0 10px 25px rgba(0,0,0,.8);
}
.tab.on::before{
  background:radial-gradient(circle at 30% 30%,#fff,var(--acc2));
}

/* Cards */
.card{
  background:
    radial-gradient(circle at 0 0,rgba(250,204,21,.06),transparent 55%),
    radial-gradient(circle at 100% 0,rgba(34,197,94,.08),transparent 55%),
    linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.90));
  border:1px solid var(--edge);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.65);
}
.grid5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
.grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.lbl{font-size:12px;color:var(--mut);margin-bottom:6px}
.inp,select{
  background:#020617;
  color:var(--text);
  border:1px solid #1f2937;
  border-radius:12px;
  padding:12px;
  width:100%;
}

/* Tag de modo de d√≠a */
.tag{
  margin-left:6px;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
}
.tag-bf{
  background:linear-gradient(90deg,#facc15,#22c55e);
  color:#111827;
  border-color:rgba(15,23,42,.8);
}

/* Horas */
.hours{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:10px}
.hbtn{
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #22272c;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
  background:linear-gradient(180deg,#020617,#020617);
  font-weight:700;
  font-size:13px;
  color:#e5e7eb;
  box-shadow:0 6px 14px rgba(0,0,0,.6);
}
.hbtn.on{
  background:linear-gradient(180deg,rgba(250,204,21,.35),rgba(34,197,94,.45));
  border-color:rgba(250,204,21,.9);
  color:#111827;
  box-shadow:0 0 0 1px rgba(15,23,42,.9) inset,0 10px 24px rgba(250,204,21,.35);
}

/* Botones */
.actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px}
.btn{
  background:linear-gradient(135deg,var(--acc),var(--acc2));
  color:#111827;
  font-weight:900;
  border:none;
  border-radius:12px;
  padding:12px 16px;
  cursor:pointer;
  font-size:13px;
  box-shadow:0 12px 30px rgba(250,204,21,.45);
}
.btn.sec{
  background:#020617;
  color:#cbd5e1;
  border:1px solid #374151;
  box-shadow:0 8px 18px rgba(15,23,42,.9);
}
.btn:hover{transform:translateY(-1px);}

/* Mensajes */
.msg{font-size:12px}
.ok{color:#22c55e}
.err{color:#ef4444}
.mut{color:#9ca3af}

/* Chips de d√≠as */
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#020617;
  font-size:12px;
}
.chip.bf{
  border-color:rgba(250,204,21,.9);
  background:radial-gradient(circle at 0 0,rgba(250,204,21,.25),transparent 55%);
}
.chip span.badge{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.08em;
  padding:2px 6px;
  border-radius:999px;
  background:rgba(250,204,21,.15);
  border:1px solid rgba(250,204,21,.7);
  color:#facc15;
}
.chip button{
  background:transparent;
  border:none;
  color:#93a3b3;
  cursor:pointer;
}

/* Tabla */
.table{margin-top:12px;border-collapse:collapse;width:100%}
th,td{border:1px solid #1f2937;padding:8px 10px;font-size:13px}
th{background:#020617;text-align:left}

/* KPI */
.kpi{
  border:1px solid #1f2937;
  background:#020617;
  border-radius:14px;
  padding:18px;
  text-align:center;
  box-shadow:0 10px 22px rgba(0,0,0,.7);
}
.kpi h3{margin:0;font-size:13px;color:#a7f3d0;text-transform:uppercase;letter-spacing:.08em}
.kpi .v{font-size:28px;font-weight:900;margin-top:8px}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.7);
}
.modal .box{
  width:min(560px,92%);
  background:#020617;
  border:1px solid #1f2937;
  border-radius:16px;
  padding:18px;
  box-shadow:0 25px 45px rgba(0,0,0,.85);
}
.box h3{margin:0 0 8px 0;font-size:16px}
.list{font-size:14px;line-height:1.7;margin:8px 0 14px 0;color:#d1d5db}
.row{display:flex;gap:10px;justify-content:flex-end}

@media (max-width:960px){
  .grid5{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media (max-width:640px){
  header{flex-direction:column;align-items:flex-start}
  .grid5,.grid3{grid-template-columns:minmax(0,1fr)}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Agente ‚Äî Turnos & M√©tricas (MTD)</h1>
      <div class="sub">Agenda (m√≠n 3h/d√≠a, Black Friday 24/7 en d√≠as especiales) y consulta tu acumulado mensual.</div>
    </div>
    <div class="sub">Capacidad fija: <b>30</b> msgs/h</div>
  </header>

  <!-- Banner Black Friday -->
  <div class="bf-banner">
    <div class="bf-pill">Black Friday Ops 24/7</div>
    <div class="bf-copy">
      Del <b>28, 29, 30 de noviembre</b> y <b>1 de diciembre</b> puedes agendar turnos en <u>cualquier hora</u> del d√≠a. üí∏‚ö°
    </div>
  </div>

  <div class="tabs">
    <button class="tab on" id="tShift">Programar turno</button>
    <button class="tab" id="tMetrics">Mis m√©tricas</button>
  </div>

  <!-- Secci√≥n turnos -->
  <section class="card" id="shiftSec">
    <div class="grid5">
      <div>
        <div class="lbl">Selecciona un d√≠a</div>
        <input class="inp" type="date" id="datePick">
      </div>
      <div style="align-self:end">
        <button class="btn sec" id="addDay">Agregar d√≠a</button>
      </div>
      <div>
        <div class="lbl">Nombre</div>
        <input class="inp" id="name" placeholder="Tu nombre">
      </div>
      <div>
        <div class="lbl">Email</div>
        <input class="inp" id="email" placeholder="tu@correo.com">
      </div>
      <div>
        <div class="lbl">Canal</div>
        <select id="channel" class="inp">
          <option value="mensajes">mensajes</option>
          <option value="llamadas">llamadas</option>
          <option value="ambos">ambos</option>
        </select>
      </div>
    </div>

    <div class="lbl" style="margin-top:10px">D√≠as seleccionados <span class="mut">(m√°x 3 por registro)</span></div>
    <div class="chips" id="days"></div>

    <div style="margin-top:14px">
      <div class="lbl">
        Horas para el d√≠a activo <span id="activeDayLabel" class="mut"></span>
        <span id="dayModeLabel" class="tag"></span> (m√≠nimo 3)
      </div>
      <div class="hours" id="hours"></div>
    </div>

    <div class="actions">
      <button class="btn" id="save">Validar y guardar</button>
      <button class="btn sec" id="viewMyShifts">Ver mis turnos</button>
      <span id="msg" class="msg"></span>
    </div>

    <div class="sub" style="margin-top:10px">Pr√≥ximos turnos (tuyos) del mes</div>
    <table class="table" id="myTbl">
      <thead>
        <tr><th>Fecha</th><th>Hora</th><th>Canal</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Secci√≥n m√©tricas -->
  <section class="card" id="metricsSec" style="display:none">
    <div class="grid5">
      <div>
        <div class="lbl">Mes (AAAA-MM)</div>
        <input class="inp" id="month" placeholder="2025-11">
      </div>
      <div>
        <div class="lbl">Tu email</div>
        <input class="inp" id="memail" placeholder="tu@correo.com">
      </div>
      <div style="align-self:end">
        <button class="btn" id="mload">Ver acumulado</button>
      </div>
    </div>

    <div class="msg" id="mmsg" style="margin-top:8px"></div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi">
        <h3>Asignadas</h3>
        <div class="v" id="k_assigned">0</div>
      </div>
      <div class="kpi">
        <h3>Atendidas</h3>
        <div class="v" id="k_attended">0</div>
      </div>
      <div class="kpi">
        <h3>Cerradas</h3>
        <div class="v" id="k_closed">0</div>
      </div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi">
        <h3>Links enviados</h3>
        <div class="v" id="k_sent">0</div>
      </div>
      <div class="kpi">
        <h3>Links pagados</h3>
        <div class="v" id="k_paid">0</div>
      </div>
      <div class="kpi">
        <h3>Ventas</h3>
        <div class="v" id="k_sales">0</div>
      </div>
    </div>

    <div class="grid3" style="margin-top:12px">
      <div class="kpi">
        <h3>Conv. / Atendidas</h3>
        <div class="v" id="k_cvr1">0%</div>
      </div>
      <div class="kpi">
        <h3>Conv. / Links enviados</h3>
        <div class="v" id="k_cvr2">0%</div>
      </div>
      <div class="kpi">
        <h3>Conv. / Links pagados</h3>
        <div class="v" id="k_cvr3">0%</div>
      </div>
    </div>
  </section>
</div>

<!-- Modal de confirmaci√≥n de turnos -->
<div class="modal" id="confirmModal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Confirma tus turnos</h3>
    <div class="list" id="confirmList"></div>
    <div class="row">
      <button class="btn sec" id="cancelConfirm">Cancelar</button>
      <button class="btn" id="acceptConfirm">Aceptar y guardar</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://wbplsmimcuphytdfjapz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{persistSession:false}});
const CSV_BASE_URL="https://fsalas-ship-it.github.io/agent-shift-planner/monthly";

const $=id=>document.getElementById(id);
const tShift=$('tShift'),tMetrics=$('tMetrics');
const shiftSec=$('shiftSec'),metricsSec=$('metricsSec');

tShift.onclick=()=>{tShift.classList.add('on');tMetrics.classList.remove('on');shiftSec.style.display='block';metricsSec.style.display='none';};
tMetrics.onclick=()=>{tMetrics.classList.add('on');tShift.classList.remove('on');shiftSec.style.display='none';metricsSec.style.display='block';};

function toast(kind,msg){ const el=$('msg'); el.className='msg '+(kind||'mut'); el.textContent=msg; }

const FIXED_CAP=30;

/* --- Configuraci√≥n de horarios --- */
// Horario normal: 9:00 a 21:00
const NORMAL_HOURS=[9,10,11,12,13,14,15,16,17,18,19,20,21];
// Black Friday 24/7: todas las horas
const FULLDAY_HOURS=Array.from({length:24},(_,i)=>i);

// D√≠as especiales 24/7: 28,29,30 nov y 01 dic (cualquier a√±o)
const SPECIAL_24H_DAYS=['11-28','11-29','11-30','12-01'];

function is24hDay(dateStr){
  if(!dateStr) return false;
  const md=dateStr.slice(5); // MM-DD
  return SPECIAL_24H_DAYS.includes(md);
}

function getHoursForDay(dateStr){
  return is24hDay(dateStr)?FULLDAY_HOURS:NORMAL_HOURS;
}
/* --- fin configuraci√≥n horarios --- */

let activeDay=null;
const selectedDays=[];
const hoursByDay={};

(function initDates(){
  const d=new Date();
  const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('datePick').value=iso;
  setActiveDay(iso,true);
})();

function updateDayModeLabel(){
  const label=$('dayModeLabel');
  if(!activeDay){
    label.textContent='';
    label.className='tag';
    return;
  }
  if(is24hDay(activeDay)){
    label.textContent='Black Friday 24/7';
    label.className='tag tag-bf';
  }else{
    label.textContent='Horario est√°ndar';
    label.className='tag';
  }
}

function setActiveDay(date,ensureAdded=false){
  activeDay=date;
  $('activeDayLabel').textContent=activeDay?('('+activeDay+')'):'';
  if(ensureAdded && !selectedDays.includes(date)) addDay(date);
  renderDays();
  updateDayModeLabel();
  paintHours();
}

function addDay(date){
  if(!date)return;
  if(selectedDays.includes(date))return setActiveDay(date);
  if(selectedDays.length>=3){return toast('err','M√°ximo 3 d√≠as por registro.');}
  selectedDays.push(date);
  hoursByDay[date]=hoursByDay[date]||new Set();
  setActiveDay(date);
}

function removeDay(date){
  const i=selectedDays.indexOf(date);
  if(i>=0){
    selectedDays.splice(i,1);
    delete hoursByDay[date];
  }
  if(selectedDays.length){ setActiveDay(selectedDays[0]); }
  else { activeDay=null; paintHours(); renderDays(); updateDayModeLabel(); }
}

$('addDay').onclick=()=>{
  const d=$('datePick').value;
  if(!d){toast('err','Selecciona un d√≠a.');return;}
  addDay(d);
};

function renderDays(){
  const box=$('days');
  box.innerHTML='';
  selectedDays.forEach(d=>{
    const isBF=is24hDay(d);
    const el=document.createElement('span');
    el.className='chip'+(isBF?' bf':'');
    el.innerHTML=`
      ${d} ${d===activeDay?'<b>(activo)</b>':''}
      ${isBF?'<span class="badge">BF 24/7</span>':''}
      <button title="Activar" data-sel="${d}">‚óè</button>
      <button title="Quitar" data-del="${d}">√ó</button>`;
    box.appendChild(el);
  });
  box.querySelectorAll('button[data-sel]').forEach(b=> b.onclick=()=> setActiveDay(b.getAttribute('data-sel')) );
  box.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=> removeDay(b.getAttribute('data-del')) );
}

function paintHours(){
  const box=$('hours');
  box.innerHTML='';
  if(!activeDay){
    box.innerHTML='<div class="mut">Primero agrega un d√≠a.</div>';
    return;
  }
  const sel=hoursByDay[activeDay]||(hoursByDay[activeDay]=new Set());
  const list=getHoursForDay(activeDay);
  list.forEach(h=>{
    const d=document.createElement('div');
    d.className='hbtn'+(sel.has(h)?' on':'');
    const label=String(h).padStart(2,'0')+":00";
    d.textContent=label;
    d.onclick=()=>{
      sel.has(h)?sel.delete(h):sel.add(h);
      paintHours();
    };
    box.appendChild(d);
  });
}

$('save').onclick=async ()=>{
  const name=$('name').value.trim();
  const email=$('email').value.trim();
  const channel=$('channel').value;
  if(!name||!email){ return toast('err','Escribe tu nombre y email.'); }
  if(selectedDays.length===0){ return toast('err','Agrega al menos 1 d√≠a.'); }
  for(const d of selectedDays){
    if((hoursByDay[d]||new Set()).size<3){
      return toast('err',`El d√≠a ${d} tiene menos de 3 horas.`);
    }
  }

  const lines=selectedDays.map(d=>{
    const arr=Array.from(hoursByDay[d]||[])
      .sort((a,b)=>a-b)
      .map(h=>`${String(h).padStart(2,'0')}:00`)
      .join(', ');
    return `<li><b>${d}</b> ‚Äî ${arr}</li>`;
  }).join('');

  $('confirmList').innerHTML=`
    <p>
      <b>Nombre:</b> ${name}<br>
      <b>Email:</b> ${email}<br>
      <b>Canal:</b> ${channel}<br>
      <b>Capacidad:</b> ${FIXED_CAP} msgs/h
    </p>
    <ul>${lines}</ul>
  `;
  showConfirm(true);

  $('acceptConfirm').onclick=async ()=>{
    showConfirm(false);
    toast('mut','Guardando‚Ä¶');
    const rows=[];
    selectedDays.forEach(d=>{
      (hoursByDay[d]||new Set()).forEach(h=>{
        rows.push({date:d,hour:h,name,email,channel,cap_msg:FIXED_CAP});
      });
    });
    try{
      const {error,status}=await sb
        .from('bookings')
        .upsert(rows,{onConflict:'date,hour,email',ignoreDuplicates:false,defaultToNull:true});
      if(error){ return toast('err',`Error (${status||'‚Äî'}): ${error.message}`); }
      toast('ok','Turnos guardados ‚úîÔ∏è');
      selectedDays.splice(0,selectedDays.length);
      for(const k in hoursByDay) delete hoursByDay[k];
      renderDays();
      paintHours();
      updateDayModeLabel();
      loadMyShifts();
    }catch(e){
      toast('err','Excepci√≥n: '+(e?.message||String(e)));
    }
  };
};

$('cancelConfirm').onclick=()=>showConfirm(false);
function showConfirm(f){ $('confirmModal').style.display
