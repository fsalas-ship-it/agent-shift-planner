<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Shift + Métricas (Día & Acumulado)</title>
  <style>
    :root{
      --bg:#05060a; --edge:#161b21; --text:#e5e7eb; --mut:#9ca3af;
      --accent:#00e676; --accent-2:#00c853; --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         color:var(--text); background:var(--bg); position:relative; overflow-x:hidden;}
    .space{position:fixed; inset:0; z-index:0; pointer-events:none;
      background: radial-gradient(1200px 800px at 70% 20%, rgba(0,230,118,0.08), transparent 60%),
                  radial-gradient(900px 600px at 20% 80%, rgba(0,200,83,0.06), transparent 60%),
                  radial-gradient(700px 500px at 40% 40%, rgba(0,230,118,0.05), transparent 60%),
                  linear-gradient(180deg, #040509, #06070c 40%, #040509);}
    .wrap{max-width:1200px; margin:0 auto; padding:28px; position:relative; z-index:2}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px}
    h1{font-size:22px; margin:0; font-weight:900; letter-spacing:0.2px}
    .sub{color:var(--mut); font-size:12px}
    .tabs{display:flex; gap:8px; margin-bottom:10px}
    .tab{border:1px solid var(--edge); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00)); color:#d1d5db; padding:10px 14px; border-radius:999px; cursor:pointer}
    .tab.on{border-color:rgba(0,230,118,0.55); color:#eafff1; box-shadow: 0 0 0 1px rgba(0,230,118,0.25) inset}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      border:1px solid var(--edge); border-radius:16px; padding:18px; backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.02) inset;}
    .grid5{display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:12px}
    .lbl{font-size:12px; color:var(--mut); margin-bottom:6px}
    .inp, select{background:#0b0f13; color:var(--text); border:1px solid #1c232a; border-radius:12px;
      padding:12px 12px; width:100%; outline:none;}
    .ro{opacity:.75; cursor:not-allowed}
    .hours{display:grid; grid-template-columns:repeat(13, minmax(0,1fr)); gap:10px}
    .hbtn{height:44px; display:flex; align-items:center; justify-content:center; border:1px solid #22272c; border-radius:12px;
      cursor:pointer; user-select:none; background:linear-gradient(180deg, #0f1113, #0b0d0f); font-weight:700; color:#d1d5db}
    .hbtn.on{background:linear-gradient(180deg, rgba(0,230,118,0.18), rgba(0,200,83,0.16));
      border-color:rgba(0,230,118,0.55); color:#eafff1; box-shadow: 0 0 0 1px rgba(0,230,118,0.25) inset}
    .actions{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:16px}
    .btn{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#062e15; font-weight:900; border:none; border-radius:12px; padding:12px 16px; cursor:pointer}
    .msg{font-size:12px} .ok{color:var(--ok)} .err{color:var(--danger)} .mut{color:var(--mut)}

    .kpis{display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:12px; margin-top:12px}
    .kpi{border:1px solid #223; background:#0b0f13; border-radius:14px; padding:14px}
    .kpi h3{margin:0; font-size:12px; color:#a7f3d0}
    .kpi .v{font-size:22px; font-weight:900; margin-top:6px}
    .kpi .s{font-size:11px; color:#9ca3af; margin-top:2px}

    table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:12px}
    th, td{padding:10px 12px; font-size:14px; text-align:left}
    th{color:#a7f3d0; font-weight:800}
    tr{background:#0b0f13; border:1px solid #1c232a}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tr td:last-child, tr th:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .chart{height:340px; display:flex; align-items:flex-end; gap:10px; padding:10px; background:#0b0f13; border:1px solid #1c232a; border-radius:14px; margin-top:12px}
    .bar{width:28px; border-radius:6px; background:linear-gradient(180deg, rgba(0,230,118,0.35), rgba(0,200,83,0.25)); border:1px solid rgba(0,230,118,0.35)}
    .bar2{width:28px; border-radius:6px; background:linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06)); border:1px solid #2a3238}

    .mode{display:flex; gap:8px; align-items:center}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid #1c232a; cursor:pointer}
    .pill.on{border-color:rgba(0,230,118,0.55); color:#eafff1}

    @media (max-width:1100px){ .grid5{grid-template-columns:repeat(2, minmax(0,1fr));} .hours{grid-template-columns:repeat(4, minmax(0,1fr));} .kpis{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:520px){ .grid5{grid-template-columns:1fr;} .hours{grid-template-columns:repeat(3, minmax(0,1fr));} .kpis{grid-template-columns:1fr;} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="space"></div>
  <div class="wrap">
    <header>
      <div>
        <h1>Agent Shift Planner</h1>
        <div class="sub">Turnos + Métricas por día y acumuladas</div>
      </div>
      <div class="sub">Capacidad fija: <b>30</b> msgs/h</div>
    </header>

    <div class="tabs">
      <button class="tab on" id="tShift">Turnos</button>
      <button class="tab" id="tMetrics">Mis métricas</button>
    </div>

    <!-- Turnos -->
    <section class="card" id="shiftSec">
      <div class="grid5">
        <div><div class="lbl">Fecha</div><input class="inp" type="date" id="date"></div>
        <div><div class="lbl">Nombre</div><input class="inp" id="name" placeholder="Tu nombre"></div>
        <div><div class="lbl">Email</div><input class="inp" id="email" placeholder="tu@correo.com"></div>
        <div><div class="lbl">Canal</div>
          <select id="channel" class="inp"><option value="mensajes">mensajes</option><option value="llamadas">llamadas</option><option value="ambos">ambos</option></select>
        </div>
        <div><div class="lbl">Capacidad (msgs/h)</div><input class="inp ro" value="30" disabled></div>
      </div>

      <div style="margin-top:14px">
        <div class="lbl">Selecciona tus horas (9:00–21:00)</div>
        <div class="hours" id="hours" aria-label="Selector de horas"></div>
      </div>

      <div class="actions">
        <button class="btn" id="save">Guardar turno(s)</button>
        <span id="msg" class="msg"></span>
      </div>
    </section>

    <!-- Métricas -->
    <section class="card" id="metricsSec" style="display:none">
      <div class="grid5">
        <div><div class="lbl">Fecha</div><input class="inp" type="date" id="mdate"></div>
        <div><div class="lbl">Tu email</div><input class="inp" id="memail" placeholder="tu@correo.com"></div>
        <div>
          <div class="lbl">CSV del día (subir)</div>
          <input class="inp" type="file" id="mfile" accept=".csv,text/csv">
        </div>
        <div>
          <div class="lbl">o URL del CSV</div>
          <input class="inp" id="murl" placeholder="https://...raw.csv">
        </div>
        <div style="align-self:end"><button class="btn" id="mrun">Ver mis métricas</button></div>
      </div>

      <div class="row" style="justify-content:space-between; align-items:center; margin-top:6px">
        <div class="mode">
          <span class="mut">Modo:</span>
          <span id="mDay" class="pill on">Por día</span>
          <span id="mAcc" class="pill">Acumulado</span>
        </div>
        <div class="mut">Campos requeridos en CSV: <b>date, email, hour, conversations, links_sent, links_paid, sales</b> (nombres flexibles).</div>
      </div>

      <div class="kpis">
        <div class="kpi"><h3>Conversaciones atendidas</h3><div class="v" id="k_convs">0</div></div>
        <div class="kpi"><h3>Links enviados</h3><div class="v" id="k_links_sent">0</div></div>
        <div class="kpi"><h3>Links pagados</h3><div class="v" id="k_links_paid">0</div></div>
        <div class="kpi"><h3>Ventas</h3><div class="v" id="k_sales">0</div></div>
        <div class="kpi"><h3>Conv. / Conversaciones</h3><div class="v" id="k_cvr_conv">0%</div><div class="s">ventas / conversaciones</div></div>
        <div class="kpi"><h3>Conv. / Links enviados</h3><div class="v" id="k_cvr_sent">0%</div><div class="s">ventas / links enviados</div></div>
      </div>
      <div class="kpi" style="margin-top:12px">
        <h3>Conv. / Links pagados</h3>
        <div class="v" id="k_cvr_paid">0%</div>
        <div class="s">ventas / links pagados</div>
      </div>

      <div class="chart" id="mchart" title="Barras: conversaciones (verde) y ventas (gris) por hora"></div>

      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Email</th><th>Hora</th><th>Conversaciones</th><th>Links enviados</th><th>Links pagados</th><th>Ventas</th>
          </tr>
        </thead>
        <tbody id="mtable"></tbody>
      </table>
      <div class="mut" id="mmsg" style="margin-top:8px"></div>
    </section>
  </div>

  <script>
    // ===== Supabase (para turnos) =====
    const SUPABASE_URL = "https://wbplsmimcuphytdfjapz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicGxzbWltY3VwaHl0ZGZqYXB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTA3NzQsImV4cCI6MjA3ODQyNjc3NH0.1iC_zrG5FU2jCv_4qzqf8Si8t3cknA705ioPwOz3zSY";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false }});
    const FIXED_CAP = 30;
    const HOURS = [9,10,11,12,13,14,15,16,17,18,19,20,21];
    const sel = new Set(); const $ = (id)=>document.getElementById(id);

    // Tabs
    const tShift = $('tShift'), tMetrics = $('tMetrics');
    const shiftSec = $('shiftSec'), metricsSec = $('metricsSec');
    tShift.onclick = ()=>{ tShift.classList.add('on'); tMetrics.classList.remove('on'); shiftSec.style.display='block'; metricsSec.style.display='none'; };
    tMetrics.onclick = ()=>{ tMetrics.classList.add('on'); tShift.classList.remove('on'); shiftSec.style.display='none'; metricsSec.style.display='block'; };

    // init date today local
    (function(){
      const d=new Date(); const iso=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      $('date').value=iso; $('mdate').value=iso;
    })();

    // Paint hours
    const paint = () => {
      const box = $('hours'); box.innerHTML='';
      HOURS.forEach(h=>{
        const d=document.createElement('div'); d.className='hbtn'+(sel.has(h)?' on':'');
        d.textContent=h+":00"; d.role="button"; d.tabIndex=0; d.setAttribute('aria-pressed', sel.has(h) ? 'true' : 'false');
        d.onclick=()=>{sel.has(h)?sel.delete(h):sel.add(h);paint();};
        d.onkeydown=(e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); d.click(); }};
        box.appendChild(d);
      });
    }; paint();

    $('save').onclick = async ()=>{
      const msg=$('msg'); msg.className='msg mut'; msg.textContent='Guardando…';
      const name=$('name').value.trim(), email=$('email').value.trim();
      const date=$('date').value, channel=$('channel').value;
      if(!name||!email||!date||sel.size===0){msg.className='msg err'; msg.textContent='Completa fecha, nombre, email y horas.'; return;}
      const rows = Array.from(sel).sort((a,b)=>a-b).map(h=>({date,hour:h,name,email,channel,cap_msg:FIXED_CAP}));
      try{
        const { error, status } = await sb.from('bookings').upsert(rows, {
          onConflict: 'date,hour,email',
          ignoreDuplicates: false,
          defaultToNull: true
        });
        if(error){ msg.className='msg err'; msg.textContent = `Error (${status||'—'}): ${error.message}`; return; }
        msg.className='msg ok'; msg.textContent='Turnos guardados/actualizados ✔️';
        sel.clear(); paint();
      }catch(e){
        msg.className='msg err'; msg.textContent='Excepción: '+(e?.message||String(e));
      }
    };

    // ===== Métricas desde CSV (día y acumulado) =====
    const mDay = $('mDay'), mAcc = $('mAcc');
    let mode = 'day'; // 'day' | 'accum'
    mDay.onclick = ()=>{ mode='day'; mDay.classList.add('on'); mAcc.classList.remove('on'); };
    mAcc.onclick = ()=>{ mode='accum'; mAcc.classList.add('on'); mDay.classList.remove('on'); };

    $('mrun').onclick = runMetrics;

    async function runMetrics(){
      const mmsg = $('mmsg'); mmsg.textContent='';
      const email = $('memail').value.trim().toLowerCase();
      const date = $('mdate').value;
      if(!email){ mmsg.textContent='Escribe tu email.'; return; }

      let rows = [];
      const file = $('mfile').files[0];
      const url = $('murl').value.trim();

      try{
        if(file){
          rows = await parseCSVFile(file);
        }else if(url){
          rows = await fetchCSV(url);
        }else{
          mmsg.textContent='Sube un CSV o indica una URL.'; return;
        }
      }catch(e){
        mmsg.textContent = 'Error leyendo CSV: ' + (e?.message||String(e));
        return;
      }

      const norm = normalizeHeaders(rows);
      let filtered = norm.filter(r=> String(r.email||'').toLowerCase()===email);
      if(mode==='day'){ filtered = filtered.filter(r=> !date || String(r.date||'')===date); }

      // Derivaciones seguras
      filtered = filtered.map(r=>{
        const sales = num(r.sales);
        const linksPaid = num(r.links_paid);
        return {
          ...r,
          conversations: num(r.conversations),
          links_sent: num(r.links_sent),
          links_paid: isNaN(linksPaid) || linksPaid===0 ? (isNaN(sales)?0:sales) : linksPaid, // usa sales si links_paid no viene
          sales: isNaN(sales) ? 0 : sales
        };
      });

      // KPIs
      const sum = (arr, f)=> arr.reduce((a,b)=> a + (Number(f(b))||0), 0);
      const convs = sum(filtered, r=>r.conversations);
      const lsent = sum(filtered, r=>r.links_sent);
      const lpaid = sum(filtered, r=>r.links_paid);
      const sales = sum(filtered, r=>r.sales);

      $('k_convs').textContent = convs;
      $('k_links_sent').textContent = lsent;
      $('k_links_paid').textContent = lpaid;
      $('k_sales').textContent = sales;

      $('k_cvr_conv').textContent = pct(safeDiv(sales, convs));
      $('k_cvr_sent').textContent = pct(safeDiv(sales, lsent));
      $('k_cvr_paid').textContent = pct(safeDiv(sales, lpaid));

      // Tabla
      const tb = $('mtable'); tb.innerHTML='';
      filtered.sort((a,b)=> (Number(a.hour)||0) - (Number(b.hour)||0));
      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date||''}</td><td>${r.email||''}</td><td>${r.hour||''}</td>
                        <td>${r.conversations||0}</td><td>${r.links_sent||0}</td><td>${r.links_paid||0}</td><td>${r.sales||0}</td>`;
        tb.appendChild(tr);
      });

      // Chart: conversaciones (verde) vs ventas (gris) por hora
      drawMChart(filtered);
      mmsg.textContent = `Modo: ${mode==='day'?'Por día':'Acumulado'} · Filas: ${filtered.length}`;
    }

    function normalizeHeaders(arr){
      const mapName = (k)=>{
        const s=String(k||'').toLowerCase().trim();
        if(['date','fecha'].includes(s)) return 'date';
        if(['email','correo'].includes(s)) return 'email';
        if(['hour','hora','h'].includes(s)) return 'hour';
        if(['conversations','convs','conversaciones','atendidas'].includes(s)) return 'conversations';
        if(['links_sent','links','enviados','links enviados','links-enviados'].includes(s)) return 'links_sent';
        if(['links_paid','paid_links','pagados','links pagados','links-pagados','pagos'].includes(s)) return 'links_paid';
        if(['sales','ventas','paid','purchased','orders'].includes(s)) return 'sales';
        return s;
      };
      return arr.map(row=>{
        const out = {};
        Object.keys(row).forEach(k=> out[mapName(k)] = row[k]);
        return out;
      });
    }

    function drawMChart(rows){
      const chart = document.getElementById('mchart'); chart.innerHTML='';
      // group by hour sum conversations & sales
      const byHour = {};
      rows.forEach(r=>{
        const h = Number(r.hour)||0;
        byHour[h] = byHour[h] || { convs:0, sales:0 };
        byHour[h].convs += Number(r.conversations)||0;
        byHour[h].sales += Number(r.sales)||0;
      });
      const hs = Object.keys(byHour).map(h=>Number(h)).sort((a,b)=>a-b);
      const max = Math.max(1, ...hs.map(h=>Math.max(byHour[h].convs, byHour[h].sales)));
      hs.forEach(h=>{
        const group = document.createElement('div');
        group.style.display='flex'; group.style.flexDirection='column'; group.style.alignItems='center'; group.style.gap='6px';
        const bars = document.createElement('div');
        bars.style.display='flex'; bars.style.alignItems='flex-end'; bars.style.gap='6px'; bars.style.height='100%';
        const b1 = document.createElement('div'); b1.className='bar'; b1.style.height = (byHour[h].convs/max*100)+'%'; b1.title=`${h}:00 → convs ${byHour[h].convs}`;
        const b2 = document.createElement('div'); b2.className='bar2'; b2.style.height = (byHour[h].sales/max*100)+'%'; b2.title=`${h}:00 → ventas ${byHour[h].sales}`;
        bars.appendChild(b1); bars.appendChild(b2);
        group.appendChild(bars);
        chart.appendChild(group);
      });
    }

    function num(v){ const n=Number(v); return isFinite(n)?n:0; }
    function safeDiv(a,b){ return b>0 ? (a/b) : 0; }
    function pct(x){ return (x*100).toFixed(1)+'%'; }

    function parseCSVFile(file){
      return new Promise((resolve, reject)=>{
        Papa.parse(file, {
          header:true,
          skipEmptyLines:true,
          complete: res=> resolve(res.data),
          error: err=> reject(err)
        });
      });
    }
    async function fetchCSV(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      return new Promise((resolve, reject)=>{
        Papa.parse(text, {
          header:true,
          skipEmptyLines:true,
          complete: r=> resolve(r.data),
          error: e=> reject(e)
        });
      });
    }
  </script>
</body>
</html>
